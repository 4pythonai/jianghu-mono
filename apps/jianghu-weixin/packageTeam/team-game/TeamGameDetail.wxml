<CustomNavBar title="{{gameType === 'single_team' ? '队内赛' : '队际赛'}}" bind:back="handleBack" />

<view class="page-container" style="padding-top: {{navBarHeight}}px;">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 主内容 -->
  <block wx:else>
    <!-- 围观人数 -->
    <SpectatorBar
      count="{{spectators.count}}"
      spectators="{{spectators.avatars}}"
      bind:more="onSpectatorMore"
    />

    <!-- Tab 切换区域 -->
    <view class="tabs-container">
      <view
        wx:for="{{tabs}}"
        wx:key="index"
        class="tab-item {{currentTab === index ? 'active' : ''}}"
        data-index="{{index}}"
        bindtap="switchTab"
      >
        <text>{{item}}</text>
        <view wx:if="{{currentTab === index}}" class="tab-indicator"></view>
      </view>
    </view>

    <!-- Tab 内容区域 -->
    <scroll-view class="tab-content" scroll-y enhanced show-scrollbar="{{false}}">
      <!-- 赛事详情 Tab -->
      <view wx:if="{{currentTab === 0}}" class="tab-panel">
        <!-- 赛事封面 -->
        <TeamEventBanner
          gameType="{{gameType}}"
          title="{{eventDetail.title}}"
          teamName="{{eventDetail.teamName}}"
          teamAvatar="{{eventDetail.teamAvatar}}"
          teams="{{eventDetail.teams}}"
          backgroundImage="{{eventDetail.backgroundImage}}"
          coverType="{{eventDetail.coverType}}"
          covers="{{eventDetail.covers}}"
        />

        <!-- 基本信息 -->
        <view class="card-wrapper">
          <InfoCard title="基本信息">
            <view class="info-list">
              <view class="info-item">
                <image class="info-icon" src="/assets/icons/icons-location.png" mode="aspectFit" />
                <text class="info-text">{{eventDetail.location}}</text>
              </view>
              <view class="info-item">
                <image class="info-icon" src="/assets/icons/icons-clock.png" mode="aspectFit" />
                <text class="info-text">{{eventDetail.dateTime}}</text>
              </view>
              <view class="info-item">
                <image class="info-icon" src="/assets/icons/icons-money.png" mode="aspectFit" />
                <text class="info-text">{{eventDetail.fee}}</text>
              </view>
              <view class="info-item">
                <image class="info-icon" src="/assets/icons/icons-deadline.png" mode="aspectFit" />
                <text class="info-text">{{eventDetail.deadline}}</text>
              </view>
            </view>
          </InfoCard>
        </view>

        <!-- 赛事流程 -->
        <view class="card-wrapper">
          <InfoCard title="赛事流程">
            <view class="schedule-list">
              <view wx:for="{{eventDetail.schedule}}" wx:key="index" class="schedule-item">
                <text class="schedule-time">{{item.time}}</text>
                <text class="schedule-content">{{item.content}}</text>
              </view>
            </view>
          </InfoCard>
        </view>

        <!-- 奖项设置 -->
        <view class="card-wrapper">
          <InfoCard title="奖项设置">
            <view class="awards-list">
              <text wx:for="{{eventDetail.awards}}" wx:key="index" class="award-item">{{item}}</text>
            </view>
          </InfoCard>
        </view>
      </view>

      <!-- 报名人员 Tab -->
      <view wx:if="{{currentTab === 1}}" class="tab-panel">
        <view class="player-count">
          <text>报名总人数：{{tagMembers.length}} 人</text>
        </view>
        <!-- 表头 -->
        <view class="player-list-header">
          <view class="header-index">序号</view>
          <view class="header-avatar-placeholder"></view>
          <view class="header-player">球员</view>
          <view class="header-handicap">江湖差点</view>
        </view>
        <!-- 分组列表 -->
        <view
          wx:for="{{tagMemberGroups}}"
          wx:key="tagId"
          wx:for-item="group"
          class="tag-group"
        >
          <view class="tag-group-header">
            <view
              class="tag-group-dot"
              style="{{group.color ? 'background-color: ' + group.color : ''}}"
            ></view>
            <text class="tag-group-title">{{group.tagName}} ({{group.members.length}})</text>
          </view>
          <view class="player-list">
            <PlayerListItem
              wx:for="{{group.members}}"
              wx:key="id"
              wx:for-item="member"
              index="{{member.tagSeq}}"
              avatar="{{member.avatar}}"
              show_name="{{member.show_name}}"
              userId="{{member.user_id}}"
              handicap="{{member.handicap}}"
            />
          </view>
          <view wx:if="{{group.members.length === 0}}" class="empty-state tag-empty-state">
            <text>暂无报名人员</text>
          </view>
        </view>
        <!-- 空状态 -->
        <view wx:if="{{tagMemberGroups.length === 0}}" class="empty-state">
          <text>暂无报名人员</text>
        </view>
      </view>

      <!-- 分组 Tab -->
      <view
        wx:if="{{currentTab === 2}}"
        class="tab-panel groups-panel {{showGroupHint ? 'groups-panel-hint' : ''}}"
      >
        <!-- 分组列表 -->
        <view class="groups-list">
          <GroupCard
            wx:for="{{groups}}"
            wx:key="id"
            group-id="{{item.id}}"
            group-name="{{item.name}}"
            players="{{item.players}}"
            deletable="{{groupingPermission === 'player' || isCreator}}"
            bind:grouptap="onGroupTap"
            bind:delete="onGroupDelete"
            bind:addPlayer="onAddPlayerToGroup"
          />
        </view>

        <!-- 添加分组按钮：groupingPermission='player' 时所有人可见，='admin' 时仅创建者可见 -->
        <view
          wx:if="{{groupingPermission === 'player' || isCreator}}"
          class="add-group-btn"
          bindtap="onAddGroup"
        >
          <text class="add-group-icon">+</text>
          <text class="add-group-text">添加分组</text>
        </view>

        <!-- 空状态：仅当无分组且无法添加分组时显示 -->
        <view
          wx:if="{{groups.length === 0 && groupingPermission === 'admin' && !isCreator}}"
          class="empty-state"
        >
          <text>暂无分组</text>
        </view>
      </view>

      <!-- 讨论区 Tab -->
      <view wx:if="{{currentTab === 3}}" class="tab-panel">
        <view class="placeholder-box">
          <text class="placeholder-text">讨论区开发中...</text>
        </view>
      </view>
    </scroll-view>

    <!-- 悬浮更多按钮（仅赛事详情Tab显示） -->
    <view wx:if="{{isCreator && currentTab === 0}}" class="floating-more-btn" bindtap="onMoreTap">
      <text>更多</text>
    </view>

    <!-- 底部操作栏（仅赛事详情Tab显示） -->
    <BottomActionBar
      wx:if="{{currentTab === 0}}"
      leftText="分享"
      rightText="{{isRegistered ? '取消报名' : '报名'}}"
      rightType="{{isRegistered ? 'warning' : 'primary'}}"
      bind:leftTap="onShareTap"
      bind:rightTap="onRegisterTap"
    />

    <!-- 报名弹窗 -->
    <view wx:if="{{showRegisterPopup}}" class="popup-mask" bindtap="onCloseRegisterPopup">
      <view class="popup-content register-popup" catchtap>
        <view class="popup-handle"></view>
        <view class="register-title">报名信息</view>

        <!-- 分队选择 -->
        <view class="tag-section">
          <view class="tag-section-title">
            请选中您所代表的参赛球队
            <text class="required">*</text>
          </view>
          <view class="tag-list">
            <view
              wx:for="{{gameTags}}"
              wx:key="id"
              class="tag-item {{selectedTagId === item.id ? 'selected' : ''}}"
              style="{{item.color ? 'border-color: ' + item.color : ''}}"
              data-tag-id="{{item.id}}"
              bindtap="onSelectTag"
            >
              <view
                class="tag-indicator"
                style="{{item.color ? 'background-color: ' + item.color : ''}}"
              ></view>
              <text class="tag-name">{{item.tagName}}</text>
              <view wx:if="{{selectedTagId === item.id}}" class="tag-check">✓</view>
            </view>
          </view>
          <view wx:if="{{gameTags.length === 0}}" class="tag-empty">
            <text>暂无分队，请联系管理员设置</text>
          </view>
        </view>

        <!-- 用户基本信息 -->
        <view class="register-form">
          <view class="form-item">
            <text class="form-label">昵称</text>
            <input
              class="form-input"
              placeholder="请输入昵称"
              value="{{registerForm.display_name}}"
              bindinput="onDisplayNameInput"
            />
          </view>
          <view class="form-item">
            <text class="form-label">手机号</text>
            <input
              class="form-input"
              placeholder="请输入手机号"
              type="number"
              maxlength="11"
              value="{{registerForm.mobile}}"
              bindinput="onMobileInput"
            />
          </view>
          <view class="form-item">
            <text class="form-label">性别</text>
            <view class="gender-radio-group">
              <view
                class="gender-radio {{registerForm.gender === 'male' ? 'selected' : ''}}"
                data-gender="male"
                bindtap="onGenderSelect"
              >
                <view class="radio-circle {{registerForm.gender === 'male' ? 'checked' : ''}}"></view>
                <text>男</text>
              </view>
              <view
                class="gender-radio {{registerForm.gender === 'female' ? 'selected' : ''}}"
                data-gender="female"
                bindtap="onGenderSelect"
              >
                <view class="radio-circle {{registerForm.gender === 'female' ? 'checked' : ''}}"></view>
                <text>女</text>
              </view>
            </view>
          </view>
        </view>

        <!-- 操作按钮 -->
        <view class="register-buttons">
          <view class="btn-cancel" bindtap="onCloseRegisterPopup">取消</view>
          <view
            class="btn-submit {{!selectedTagId ? 'disabled' : ''}}"
            bindtap="onSubmitRegister"
          >提交报名</view>
        </view>
      </view>
    </view>

    <!-- 更多操作弹窗 -->
    <view wx:if="{{showMoreActions}}" class="popup-mask" bindtap="onCloseMoreActions">
      <view class="popup-content" catchtap>
        <view class="popup-handle"></view>
        <view class="actions-grid">
          <view class="action-item" data-action="registerForFriend" bindtap="onActionTap">
            <view class="action-icon icon-friend">
              <image class="btn-icon-img" src="/assets/icons/icons8-apply-48.png" mode="aspectFit" />
            </view>
            <text class="action-text">替好友报名</text>
          </view>
          <view class="action-item" data-action="closeRegistration" bindtap="onActionTap">
            <view class="action-icon icon-close-reg">
              <image
                class="btn-icon-img"
                src="/assets/icons/icons8-checkbox-48.png"
                mode="aspectFit"
              />
            </view>
            <text class="action-text">关闭报名</text>
          </view>
          <view class="action-item" data-action="managePlayer" bindtap="onActionTap">
            <view class="action-icon icon-manage">
              <image class="btn-icon-img" src="/assets/icons/icons8-swap-48.png" mode="aspectFit" />
            </view>
            <text class="action-text">选手管理</text>
          </view>
          <view class="action-item" data-action="editGame" bindtap="onActionTap">
            <view class="action-icon icon-edit">
              <image class="btn-icon-img" src="/assets/icons/icons8-edit-48.png" mode="aspectFit" />
            </view>
            <text class="action-text">修改比赛</text>
          </view>
          <view class="action-item" data-action="editGroup" bindtap="onActionTap">
            <view class="action-icon icon-group">
              <image class="btn-icon-img" src="/assets/icons/icons8-group-48.png" mode="aspectFit" />
            </view>
            <text class="action-text">修改分组</text>
          </view>
          <view class="action-item" data-action="manageFee" bindtap="onActionTap">
            <view class="action-icon icon-fee">
              <image class="btn-icon-img" src="/assets/icons/icons8-coins-48.png" mode="aspectFit" />
            </view>
            <text class="action-text">收费管理</text>
          </view>
          <view class="action-item" data-action="cancelGame" bindtap="onActionTap">
            <view class="action-icon icon-cancel">
              <image
                class="btn-icon-img"
                src="/assets/icons/icons8-stopgame-48.png"
                mode="aspectFit"
              />
            </view>
            <text class="action-text">取消比赛</text>
          </view>

          <view class="action-item" data-action="startGame" bindtap="onActionTap">
            <view class="action-icon action-icon-start">
              <image class="btn-icon-img" src="/assets/icons/icons8-start-48.png" mode="aspectFit" />
            </view>
            <text class="action-text">开始比赛</text>
          </view>

          <view class="action-item" data-action="manageScore" bindtap="onActionTap">
            <view class="action-icon action-icon-score">
              <image class="btn-icon-img" src="/assets/icons/icons8-edit-48.png" mode="aspectFit" />
            </view>
            <text class="action-text">记分管理</text>
          </view>
        </view>
        <view class="popup-cancel" bindtap="onCloseMoreActions">
          <text>取消</text>
        </view>
      </view>
    </view>
  </block>
</view>
