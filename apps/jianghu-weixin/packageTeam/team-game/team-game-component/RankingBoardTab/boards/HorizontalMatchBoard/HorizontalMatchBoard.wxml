<wxs src="./tools.wxs" module="tools" />
<wxs src="/utils/image.wxs" module="image" />
<view class="match-board" wx:if="{{vm}}">
  <!-- Summary header -->
  <view class="match-header">
    <view class="team team-left">
      <view class="team-badge" style="background-color: {{vm.header.left.tag_color || '#D32F2F'}}"></view>
      <text class="team-name">{{vm.header.left.tag_name}}</text>
      <text class="team-points">{{vm.header.pointsLeftText}}</text>
    </view>
    <view class="team team-right">
      <text class="team-points">{{vm.header.pointsRightText}}</text>
      <text class="team-name">{{vm.header.right.tag_name}}</text>
      <view class="team-badge" style="background-color: {{vm.header.right.tag_color || '#1976D2'}}"></view>
    </view>
  </view>

  <!-- Matches list -->
  <view class="match-list">
    <view wx:if="{{!vm.rows || vm.rows.length === 0}}" class="empty">
      <text class="empty-text">暂无对阵</text>
    </view>

    <view wx:for="{{vm.rows}}" wx:key="group_id" class="match-item">
      <view wx:if="{{item.group_name}}" class="group-name">
        <text>{{item.group_name}}</text>
      </view>

      <view class="match-row">
        <!-- left -->
        <view
          class="side side-left {{item.winnerSide === 'left' ? 'winner' : (item.winnerSide ? 'loser' : '')}} {{expandedMatchGroupId === item.group_id && tools.isSideSelected(expandedUserId, item.left) ? 'selected-player' : ''}}"
          style="{{item.winnerSide === 'left' ? ('background-color:' + (item.left.tag_color || '#D32F2F')) : ''}}"
        >
          <view
            class="side-content-wrapper"
            bind:tap="{{item.left.type === 'player' ? 'onPlayerTap' : ''}}"
            data-group-id="{{item.group_id}}"
            data-user-id="{{item.left.user_id}}"
          >
            <view class="side-content">
              <image
                wx:if="{{item.left.type === 'player'}}"
                class="avatar"
                mode="aspectFill"
                src="{{image.imageUrl(item.left.avatarUrl) || '/assets/images/default-avatar.png'}}"
              />
              <view
                wx:else
                class="tag-dot"
                style="background-color: {{item.left.tag_color || '#D32F2F'}}"
              ></view>

              <view class="name-block">
                <view class="name-row">
                  <text class="name">{{item.left.show_name}}</text>
                  <text
                    wx:if="{{!vm.isSummary && item.left.type === 'player' && item.left.tag_name}}"
                    class="tag-pill"
                    style="background-color: {{item.left.tag_color || '#D32F2F'}}"
                  >{{item.left.tag_name}}</text>
                </view>
                <!-- For tags, show clickable members -->
                <view wx:if="{{item.left.type === 'tag' && item.left.members.length > 0}}" class="sub members-list">
                  <block wx:for="{{item.left.members}}" wx:for-item="member" wx:key="user_id">
                    <text
                      class="member-item"
                      bind:tap="onPlayerTap"
                      data-group-id="{{item.group_id}}"
                      data-user-id="{{member.user_id}}"
                    >{{member.show_name}}</text>
                    <text wx:if="{{!index.last}}"> / </text>
                  </block>
                </view>
              </view>
            </view>
          </view>
          <text wx:if="{{item.leftResultText}}" class="result">{{item.leftResultText}}</text>
        </view>

        <!-- middle -->
        <view class="mid">
          <text class="thru">{{item.thruLabel}}</text>
          <text wx:if="{{item.centerResultText}}" class="mid-result">{{item.centerResultText}}</text>
        </view>

        <!-- right -->
        <view
          class="side side-right {{item.winnerSide === 'right' ? 'winner' : (item.winnerSide ? 'loser' : '')}} {{expandedMatchGroupId === item.group_id && tools.isSideSelected(expandedUserId, item.right) ? 'selected-player' : ''}}"
          style="{{item.winnerSide === 'right' ? ('background-color:' + (item.right.tag_color || '#1976D2')) : ''}}"
        >
          <text wx:if="{{item.rightResultText}}" class="result">{{item.rightResultText}}</text>
          <view
            class="side-content-wrapper"
            bind:tap="{{item.right.type === 'player' ? 'onPlayerTap' : ''}}"
            data-group-id="{{item.group_id}}"
            data-user-id="{{item.right.user_id}}"
          >
            <view class="side-content side-content-right">
              <view class="name-block name-block-right">
                <view class="name-row name-row-right">
                  <text
                    wx:if="{{!vm.isSummary && item.right.type === 'player' && item.right.tag_name}}"
                    class="tag-pill"
                    style="background-color: {{item.right.tag_color || '#1976D2'}}"
                  >{{item.right.tag_name}}</text>
                  <text class="name">{{item.right.show_name}}</text>
                </view>
                <!-- For tags, show clickable members -->
                <view wx:if="{{item.right.type === 'tag' && item.right.members.length > 0}}" class="sub members-list-right">
                  <block wx:for="{{item.right.members}}" wx:for-item="member" wx:key="user_id">
                    <text
                      class="member-item"
                      bind:tap="onPlayerTap"
                      data-group-id="{{item.group_id}}"
                      data-user-id="{{member.user_id}}"
                    >{{member.show_name}}</text>
                    <text wx:if="{{!index.last}}"> / </text>
                  </block>
                </view>
              </view>

              <image
                wx:if="{{item.right.type === 'player'}}"
                class="avatar"
                mode="aspectFill"
                src="{{image.imageUrl(item.right.avatarUrl) || '/assets/images/default-avatar.png'}}"
              />
              <view
                wx:else
                class="tag-dot"
                style="background-color: {{item.right.tag_color || '#1976D2'}}"
              ></view>
            </view>
          </view>
        </view>
      </view>

      <!-- Expanded Player Score Detail -->
      <view
        class="expand-container"
        wx:if="{{expandedMatchGroupId === item.group_id && expandedUserId}}"
      >
        <expand-player-score
          holeList="{{holeList}}"
          playerScores="{{displayScores[expandedPlayerIndex]}}"
        ></expand-player-score>
      </view>
    </view>
  </view>
</view>
