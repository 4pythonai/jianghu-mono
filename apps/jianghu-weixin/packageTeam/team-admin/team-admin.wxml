<view class="container">
  <CustomNavBar title="管理员设置" showBack="{{true}}" />

  <view class="page-content" style="padding-top: {{navBarHeight}}px;">
    <!-- 加载中 -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>

    <view class="main-content" wx:else>
      <!-- 当前管理员 -->
      <view class="section">
        <view class="section-title">当前管理员</view>
        <view class="member-card" wx:for="{{admins}}" wx:key="user_id">
          <view class="member-avatar-wrap">
            <PlayerAvatar
              avatar="{{item.avatar}}"
              userId="{{item.user_id}}"
              avatarOnly="{{true}}"
              size="medium"
            />
          </view>
          <view class="member-info">
            <view class="member-name">{{item.show_name || '未设置昵称'}}</view>
            <view class="member-role">
              <text wx:if="{{item.role === 'SuperAdmin'}}" class="role-tag team-superadmin">超级管理员</text>
              <text wx:else class="role-tag admin">管理员</text>
            </view>
          </view>
          <!-- 普通管理员可配置权限或取消 -->
          <view class="action-btns" wx:if="{{item.role === 'admin'}}">
            <view class="action-btn" catchtap="onEditPermissions" data-member="{{item}}">
              <text>权限</text>
            </view>
            <view
              class="action-btn danger"
              catchtap="onRemoveAdmin"
              data-user-id="{{item.user_id}}"
              data-shown-name="{{item.show_name}}"
            >
              <text>取消</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 普通成员 -->
      <view class="section">
        <view class="section-title">普通成员（点击设为管理员）</view>
        <view
          class="member-card"
          wx:for="{{normalMembers}}"
          wx:key="user_id"
          bindtap="onSetAdmin"
          data-user-id="{{item.user_id}}"
          data-shown-name="{{item.show_name}}"
        >
          <view class="member-avatar-wrap">
            <PlayerAvatar
              avatar="{{item.avatar}}"
              userId="{{item.user_id}}"
              avatarOnly="{{true}}"
              size="medium"
              clickable="{{false}}"
            />
          </view>
          <view class="member-info">
            <view class="member-name">{{item.show_name || '未设置昵称'}}</view>
          </view>
          <view class="set-admin-hint">
            <text>设为管理员</text>
            <image class="arrow-icon" src="/assets/icons/arrow-right.svg" mode="aspectFit"></image>
          </view>
        </view>
        <view class="empty-hint" wx:if="{{normalMembers.length === 0}}">
          <text>暂无普通成员</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 权限设置弹窗 -->
  <view class="modal-mask" wx:if="{{showPermissionModal}}" catchtap="closePermissionModal"></view>
  <view class="modal-content" wx:if="{{showPermissionModal}}" catchtap>
    <view class="modal-header">
      <text class="modal-title">权限设置 - {{editingMember.show_name}}</text>
      <view class="modal-close" catchtap="closePermissionModal">×</view>
    </view>
    <view class="modal-body">
      <view class="permission-item" wx:for="{{permissionOptions}}" wx:key="key">
        <text class="permission-label">{{item.label}}</text>
        <switch
          class="permission-switch"
          checked="{{editingPermissions[item.key]}}"
          bindchange="onPermissionChange"
          data-key="{{item.key}}"
          color="#2e7d32"
        />
      </view>
    </view>
    <view class="modal-footer">
      <view class="modal-btn cancel" catchtap="closePermissionModal">取消</view>
      <view class="modal-btn confirm" catchtap="savePermissions">保存</view>
    </view>
  </view>
</view>
