<!--
  队际赛表单页面
  复用队内赛表单布局，适配多球队模式
-->
<wxs module="img" src="../../../utils/image.wxs"></wxs>
<CustomNavBar title="创建队际赛" />
<view class="page-container">
  <view class="main-card">
    <view class="card-content">
      <!-- 参赛球队列表 -->
      <view class="form-item">
        <view class="form-label">
          <text>参赛球队</text>
          <text class="form-sub-label">({{selectedTeams.length}}个球队)</text>
        </view>
        <view class="teams-container">
          <view class="team-card" wx:for="{{selectedTeams}}" wx:key="team_id">
            <image class="team-avatar" src="{{img.imageUrl(item.team_avatar)  }}" mode="aspectFill"></image>
            <view class="team-info">
              <view class="team-alias">{{item.team_alias}}</view>
              <view
                class="team-name"
                wx:if="{{item.team_alias !== item.team_name}}"
              >{{item.team_name}}</view>
            </view>
            <view class="edit-alias-btn" bindtap="editTeamAlias" data-team-id="{{item.team_id}}">
              <image src="/assets/icons/icons8-edit-48.png" mode="aspectFit"></image>
            </view>
          </view>
          <view class="reselect-teams-btn" bindtap="goBackToTeamSelect">
            <text>重新选择球队</text>
          </view>
        </view>
      </view>

      <view class="game-form">
        <!-- 比赛名称 -->
        <view class="form-item">
          <view class="form-label">比赛名称</view>
          <view class="form-input-wrapper">
            <input
              class="form-input"
              type="text"
              placeholder="请输入比赛名称"
              placeholder-class="input-placeholder"
              value="{{formData.name}}"
              bindinput="onNameInput"
              maxlength="50"
            />
          </view>
        </view>

        <!-- 比赛场地 -->
        <view class="form-item">
          <view class="form-label">比赛场地</view>
          <view class="search-input" bindtap="goToCourseSelect" wx:if="{{!selectedCourse}}">
            <input type="text" placeholder="选择球场" placeholder-class="input-placeholder" disabled />
            <view class="arrow-icon">
              <image src="/assets/icons/arrow-right.svg" mode="aspectFit"></image>
            </view>
          </view>
          <view class="selected-course" wx:if="{{selectedCourse}}">
            <view class="course-info" bindtap="goToCourseSelect">
              <view class="course-details">
                <view class="course-name">{{selectedCourse.name}}</view>
                <view class="court-info" wx:if="{{selectedCourt}}">
                  <text class="court-name">{{selectedCourt.name}}</text>
                </view>
              </view>
              <view class="arrow-icon">
                <image src="/assets/icons/arrow-right.svg" mode="aspectFit"></image>
              </view>
            </view>
            <view class="clear-btn" bindtap="clearSelectedCourse">
              <image src="/assets/icons/close.svg" mode="aspectFit"></image>
            </view>
          </view>
        </view>

        <!-- 比赛时间 -->
        <view class="form-item">
          <view class="form-label">比赛时间</view>
          <view class="form-input-wrapper">
            <TimePicker
              value="{{formData.openTime}}"
              placeholder="请选择开球时间"
              bind:change="onOpenTimeChange"
            />
          </view>
        </view>

        <!-- 报名截止时间 -->
        <view class="form-item">
          <view class="form-label">
            <text>报名截止时间</text>
            <text class="form-sub-label">(可选)</text>
          </view>
          <view class="form-input-wrapper">
            <TimePicker
              value="{{formData.registrationDeadline}}"
              placeholder="请选择报名截止时间"
              bind:change="onRegistrationDeadlineChange"
            />
          </view>
        </view>

        <!-- 参赛费用 -->
        <view class="form-item">
          <view class="form-label">
            <text>参赛费用</text>
            <text class="form-sub-label">(仅展示，不涉及支付)</text>
          </view>
          <view class="form-input-wrapper input-with-unit">
            <input
              class="form-input"
              type="digit"
              placeholder="0"
              placeholder-class="input-placeholder"
              value="{{formData.entryFee}}"
              bindinput="onEntryFeeInput"
            />
            <text class="input-unit">元</text>
          </view>
        </view>

        <!-- 比赛赛制 -->
        <view class="form-item">
          <view class="form-label">
            <text>比赛赛制</text>
            <text class="form-sub-label match-tip" wx:if="{{selectedTeams.length > 2}}">(超过2队不可选比洞赛)</text>
          </view>
          <view class="format-options">
            <radio-group bindchange="onMatchFormatChange">
              <view
                wx:for="{{matchFormats}}"
                wx:key="value"
                class="format-item {{formData.matchFormat === item.value ? 'active' : ''}} {{item.disabled ? 'disabled' : ''}}"
              >
                <label class="format-label">
                  <radio
                    value="{{item.value}}"
                    checked="{{formData.matchFormat === item.value}}"
                    color="{{'var(--primary-green-dark)'}}"
                    disabled="{{item.disabled}}"
                  />
                  <text class="format-text {{item.disabled ? 'text-disabled' : ''}}">{{item.label}}</text>
                </label>
              </view>
            </radio-group>
          </view>
        </view>

        <!-- 取前N名成绩 -->
        <view class="form-item">
          <view class="form-label">
            <text>取前N名成绩排行</text>
            <text class="form-sub-label">(可选，默认取人数最少球队的人数)</text>
          </view>
          <view class="form-input-wrapper input-with-unit">
            <input
              class="form-input"
              type="number"
              placeholder="如：5"
              placeholder-class="input-placeholder"
              value="{{formData.topNRanking}}"
              bindinput="onTopNRankingInput"
            />
            <text class="input-unit">名</text>
          </view>
        </view>

        <!-- 奖项设置 -->
        <view class="form-item">
          <view class="form-label">
            <text>奖项设置</text>
            <text class="form-sub-label">(可选)</text>
          </view>
          <view class="form-input-wrapper">
            <textarea
              class="form-textarea"
              placeholder="输入奖项说明，如：冠军奖品xxx"
              placeholder-class="input-placeholder"
              value="{{formData.awards}}"
              bindinput="onAwardsInput"
              maxlength="500"
              auto-height
            />
          </view>
        </view>

        <!-- 赛事流程 -->
        <view class="form-item">
          <view class="form-label">
            <text>赛事流程</text>
            <text class="form-sub-label">(可选)</text>
          </view>
          <view class="schedule-container">
            <view wx:for="{{formData.schedule}}" wx:key="index" class="schedule-item-edit">
              <view class="schedule-time-input">
                <input
                  type="text"
                  placeholder="时间，如 08:00"
                  value="{{item.time}}"
                  bindinput="onScheduleTimeInput"
                  data-index="{{index}}"
                />
              </view>
              <view class="schedule-content-input">
                <input
                  type="text"
                  placeholder="内容，如 签到集合"
                  value="{{item.content}}"
                  bindinput="onScheduleContentInput"
                  data-index="{{index}}"
                />
              </view>
              <view class="delete-schedule-btn" bindtap="deleteScheduleItem" data-index="{{index}}">
                <image src="/assets/icons/close.svg" mode="aspectFit"></image>
              </view>
            </view>
            <view class="add-schedule-btn" bindtap="addScheduleItem">
              <image src="/assets/icons/add.svg" class="add-icon" mode="aspectFit"></image>
              <text>添加流程</text>
            </view>
          </view>
        </view>

        <!-- 分组权限 -->
        <view class="form-item">
          <view class="form-label">分组权限</view>
          <view class="radio-group">
            <radio-group bindchange="onGroupingPermissionChange">
              <label class="radio-item">
                <radio
                  value="admin"
                  checked="{{formData.groupingPermission === 'admin'}}"
                  color="{{'var(--primary-green-dark)'}}"
                />
                <text class="radio-text">管理员分组</text>
              </label>
              <label class="radio-item">
                <radio
                  value="player"
                  checked="{{formData.groupingPermission === 'player'}}"
                  color="{{'var(--primary-green-dark)'}}"
                />
                <text class="radio-text">球员自由选择</text>
              </label>
            </radio-group>
          </view>
        </view>

        <!-- 是否公开报名 -->
        <view class="form-item">
          <view class="form-label">是否公开报名</view>
          <view class="radio-group">
            <radio-group bindchange="onIsPublicChange">
              <label class="radio-item">
                <radio
                  value="y"
                  checked="{{formData.isPublic === 'y'}}"
                  color="{{'var(--primary-green-dark)'}}"
                />
                <text class="radio-text">公开 (任意人可报名)</text>
              </label>
              <label class="radio-item">
                <radio
                  value="n"
                  checked="{{formData.isPublic === 'n'}}"
                  color="{{'var(--primary-green-dark)'}}"
                />
                <text class="radio-text">仅参赛球队成员</text>
              </label>
            </radio-group>
          </view>
        </view>
      </view>

      <!-- 提交按钮 -->
      <view class="action-footer">
        <button
          class="create-btn {{submitting ? 'disabled' : ''}}"
          bindtap="onSubmit"
          disabled="{{submitting}}"
        >{{submitting ? '创建中...' : '创建并开启报名'}}</button>
      </view>
    </view>
  </view>
</view>
