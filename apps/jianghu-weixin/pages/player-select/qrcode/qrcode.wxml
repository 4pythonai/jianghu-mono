<wxs src="/utils/image.wxs" module="image" />
<CustomNavBar title="二维码邀请" />
<view class="container">
  <view class="qrcode-card">
    <view wx:if="{{loading}}" class="status loading">
      <text>正在生成二维码...</text>
    </view>
    <view wx:elif="{{error}}" class="status error">
      <text class="error-text">{{error}}</text>
      <button class="outline-btn" bindtap="handleRetry">重新生成</button>
    </view>
    <view wx:elif="{{qrcodeUrl}}" class="qrcode-wrapper">
      <image
        class="qrcode-image"
        src="{{qrcodeUrl}}"
        mode="aspectFit"
        show-menu-by-longpress="true"
        bindtap="handlePreview"
      ></image>
      <text class="hint">好友扫描后即可加入比赛，长按可保存或转发</text>
    </view>
    <view wx:else class="status placeholder">
      <text>二维码尚未生成</text>
    </view>

    <view class="action-row" wx:if="{{qrcodeUrl}}">
      <button class="primary-btn" bindtap="handlePreview">预览二维码</button>
      <button class="secondary-btn" bindtap="handleSave">保存到相册</button>
    </view>
  </view>

  <view class="info-card">
    <view class="info-item">
      <text class="info-label">邀请码</text>
      <view class="info-value-row">
        <text class="info-value">{{uuid || '未生成'}}</text>
        <button class="ghost-btn" bindtap="handleCopyInvite" wx:if="{{uuid}}">复制</button>
      </view>
    </view>

    <view class="info-item" wx:if="{{hasGameId}}">
      <text class="info-label">比赛ID</text>
      <text class="info-value">{{gameid}}</text>
    </view>

    <view class="info-item" wx:if="{{showTestButton}}">
      <view class="info-value-row">
        <button class="test-btn" bindtap="handleTestNavigate">跳转到邀请页</button>
        <button class="test-btn test-btn-secondary" bindtap="handleTestNotification">模拟入场通知</button>
      </view>
    </view>
  </view>

  <view class="groups-card" wx:if="{{hasGameId}}">
    <view class="groups-card-header">
      <text class="groups-title">分组报名详情</text>
      <text class="groups-status" wx:if="{{groupsLoading}}">加载中...</text>
      <text class="groups-status" wx:elif="{{groupsRefreshing}}">刷新中...</text>
    </view>

    <view class="groups-feedback" wx:if="{{groupsError}}">
      <text class="groups-error-text">{{groupsError}}</text>
      <button class="ghost-btn groups-retry-btn" bindtap="handleGroupsRetry">重新加载</button>
    </view>

    <view class="groups-loading" wx:if="{{groupsLoading}}">
      <text>组别加载中，请稍候...</text>
    </view>

    <block wx:if="{{!groupsLoading && groups.length}}">
      <view class="group-list">
        <view
          class="group-item"
          wx:for="{{groups}}"
          wx:key="groupid"
          wx:for-index="groupIndex"
          wx:for-item="group"
        >
          <view class="group-header">
            <text class="group-name">{{group.group_name || ('第' + (groupIndex + 1) + '组')}}</text>
            <text
              class="group-count"
            >{{group.user_count || (group.users && group.users.length) || 0}}人已加入</text>
          </view>
          <view class="user-list" wx:if="{{group.users && group.users.length}}">
            <view class="user-item" wx:for="{{group.users}}" wx:key="userid" wx:for-item="user">
              <image
                class="user-avatar"
                src="{{image.imageUrl(user.avatar) || '/images/default-avatar.png'}}"
                mode="aspectFill"
              ></image>
              <text class="user-name">{{user.nickname || user.nickName || '匿名球友'}}</text>
            </view>
          </view>
          <view class="group-empty" wx:else>
            <text class="group-empty-text">等待球友加入...</text>
          </view>
        </view>
      </view>
    </block>

    <view class="groups-empty" wx:if="{{!groupsLoading && !groups.length && !groupsError}}">
      <text>当前暂无球友加入，快邀请好友扫码吧</text>
    </view>
  </view>

  <view class="tips-card">
    <text class="tips-title">使用说明</text>
    <view class="tips-item">
      <text>1. 点击“预览二维码”，长按图片即可分享或保存。</text>
    </view>
    <view class="tips-item">
      <text>2. 好友扫码后将进入邀请页，可一键加入比赛。</text>
    </view>
  </view>
</view>

<view class="notification-layer" wx:if="{{notifications.length}}">
  <block wx:for="{{notifications}}" wx:key="id">
    <view
      class="notification-card {{item.state === 'leave' ? 'notification-leave' : 'notification-enter'}}"
    >
      <image class="notification-avatar" src="{{image.imageUrl(item.avatar)}}" mode="aspectFill"></image>
      <view class="notification-content">
        <text class="notification-title">{{item.nickname}}</text>
        <text class="notification-message">加入比赛</text>
      </view>
    </view>
  </block>
</view>
