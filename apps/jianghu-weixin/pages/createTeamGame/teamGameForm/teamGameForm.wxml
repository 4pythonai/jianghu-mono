<CustomNavBar title="创建队内赛" />
<view class="page-container">
  <view class="main-card">
    <view class="card-content">
      <!-- 球队选择 -->
      <view class="form-item">
        <view class="form-label">球队</view>
        <view class="selected-team" bindtap="goToTeamSelect">
          <image src="{{ selectedTeam.team_avatar   }}" class="team-avatar" mode="aspectFill"></image>
          <view class="team-details">
            <view class="team-name">{{ selectedTeam.team_name || teamName }}</view>
            <view class="team-role" wx:if="{{ selectedTeam.role }}">
              <text
                class="role-tag {{ selectedTeam.role }}"
              >{{ selectedTeam.role === 'owner' ? '队长' : (selectedTeam.role === 'admin' ? '管理员' : '成员') }}</text>
            </view>
          </view>
          <view class="reselect-hint">
            <text>点击更换</text>
          </view>
          <view class="arrow-icon">
            <image src="/assets/icons/arrow-right.svg" mode="aspectFit"></image>
          </view>
        </view>
      </view>

      <view class="game-form">
        <!-- 比赛名称 -->
        <view class="form-item">
          <view class="form-label">比赛名称</view>
          <view class="form-input-wrapper">
            <input
              class="form-input"
              type="text"
              placeholder="请输入比赛名称"
              placeholder-class="input-placeholder"
              value="{{ formData.name }}"
              bindinput="onNameInput"
              maxlength="50"
            />
          </view>
        </view>

        <!-- 比赛场地 -->
        <view class="form-item">
          <view class="form-label">比赛场地</view>
          <view class="search-input" bindtap="goToCourseSelect" wx:if="{{ !selectedCourse }}">
            <input type="text" placeholder="选择球场" placeholder-class="input-placeholder" disabled />
            <view class="arrow-icon">
              <image src="/assets/icons/arrow-right.svg" mode="aspectFit"></image>
            </view>
          </view>
          <view class="selected-course" wx:if="{{ selectedCourse }}">
            <view class="course-info" bindtap="goToCourseSelect">
              <view class="course-details">
                <view class="course-name">{{ selectedCourse.name }}</view>
                <view class="court-info" wx:if="{{ selectedCourt }}">
                  <text class="court-name">{{ selectedCourt.name }}</text>
                </view>
              </view>
              <view class="arrow-icon">
                <image src="/assets/icons/arrow-right.svg" mode="aspectFit"></image>
              </view>
            </view>
            <view class="clear-btn" bindtap="clearSelectedCourse">
              <image src="/assets/icons/close.svg" mode="aspectFit"></image>
            </view>
          </view>
        </view>

        <!-- 比赛时间 -->
        <view class="form-item">
          <view class="form-label">比赛时间</view>
          <view class="form-input-wrapper">
            <TimePicker
              value="{{ formData.openTime }}"
              placeholder="请选择开球时间"
              bind:change="onOpenTimeChange"
            />
          </view>
        </view>

        <!-- 报名截止时间 -->
        <view class="form-item">
          <view class="form-label">
            <text>报名截止时间</text>
            <text class="form-sub-label">(可选)</text>
          </view>
          <view class="form-input-wrapper">
            <TimePicker
              value="{{ formData.registrationDeadline }}"
              placeholder="请选择报名截止时间"
              bind:change="onRegistrationDeadlineChange"
            />
          </view>
        </view>

        <!-- 参赛费用 -->
        <view class="form-item">
          <view class="form-label">
            <text>参赛费用</text>
            <text class="form-sub-label">(仅展示，不涉及支付)</text>
          </view>
          <view class="form-input-wrapper input-with-unit">
            <input
              class="form-input"
              type="digit"
              placeholder="0"
              placeholder-class="input-placeholder"
              value="{{ formData.entryFee }}"
              bindinput="onEntryFeeInput"
            />
            <text class="input-unit">元</text>
          </view>
        </view>

        <!-- 比赛赛制 -->
        <view class="form-item">
          <view class="form-label">比赛赛制</view>
          <view class="format-options">
            <radio-group bindchange="onMatchFormatChange">
              <view
                wx:for="{{ matchFormats }}"
                wx:key="value"
                class="format-item {{ formData.matchFormat === item.value ? 'active' : '' }}"
              >
                <label class="format-label">
                  <radio
                    value="{{ item.value }}"
                    checked="{{ formData.matchFormat === item.value }}"
                    color="{{ 'var(--primary-green-dark)' }}"
                  />
                  <text class="format-text">{{ item.label }}</text>
                </label>
              </view>
            </radio-group>
          </view>
        </view>

        <!-- 分队设置 (团队赛制时显示) -->
        <view class="form-item" wx:if="{{ currentFormat.requireSubteam }}">
          <view class="form-label">
            <text>分队设置</text>
            <text class="form-sub-label" wx:if="{{ currentFormat.isMatch }}">(比洞赛限2队)</text>
          </view>
          <view class="subteams-container">
            <view
              wx:for="{{ subteams }}"
              wx:key="index"
              class="subteam-item"
              style="border-left-color: {{ item.color }};"
            >
              <input
                class="subteam-input"
                type="text"
                value="{{ item.name }}"
                bindinput="onSubteamNameInput"
                data-index="{{ index }}"
                placeholder="分队名称"
              />
              <view
                class="delete-subteam-btn"
                bindtap="deleteSubteam"
                data-index="{{ index }}"
                wx:if="{{ subteams.length > 2 || !currentFormat.requireSubteam }}"
              >
                <image src="/assets/icons/close.svg" mode="aspectFit"></image>
              </view>
            </view>
            <view
              class="add-subteam-btn"
              bindtap="addSubteam"
              wx:if="{{ !currentFormat.isMatch || subteams.length < 2 }}"
            >
              <image src="/assets/icons/add.svg" class="add-icon" mode="aspectFit"></image>
              <text>添加分队</text>
            </view>
          </view>
        </view>

        <!-- 取前N名成绩 (团队赛制时显示) -->
        <view class="form-item" wx:if="{{ currentFormat.requireSubteam }}">
          <view class="form-label">
            <text>取前N名成绩排行</text>
            <text class="form-sub-label">(可选)</text>
          </view>
          <view class="form-input-wrapper input-with-unit">
            <input
              class="form-input"
              type="number"
              placeholder="如：3"
              placeholder-class="input-placeholder"
              value="{{ formData.topNRanking }}"
              bindinput="onTopNRankingInput"
            />
            <text class="input-unit">名</text>
          </view>
        </view>

        <!-- 奖项设置 -->
        <view class="form-item">
          <view class="form-label">
            <text>奖项设置</text>
            <text class="form-sub-label">(可选)</text>
          </view>
          <view class="form-input-wrapper">
            <textarea
              class="form-textarea"
              placeholder="输入奖项说明，如：冠军奖品xxx"
              placeholder-class="input-placeholder"
              value="{{ formData.awards }}"
              bindinput="onAwardsInput"
              maxlength="500"
              auto-height
            />
          </view>
        </view>

        <!-- 赛事流程 -->
        <view class="form-item">
          <view class="form-label">
            <text>赛事流程</text>
            <text class="form-sub-label">(可选)</text>
          </view>
          <view class="schedule-container">
            <view
              wx:for="{{ formData.schedule }}"
              wx:key="index"
              class="schedule-item-edit"
            >
              <view class="schedule-time-input">
                <input
                  type="text"
                  placeholder="时间，如 08:00"
                  value="{{ item.time }}"
                  bindinput="onScheduleTimeInput"
                  data-index="{{ index }}"
                />
              </view>
              <view class="schedule-content-input">
                <input
                  type="text"
                  placeholder="内容，如 签到集合"
                  value="{{ item.content }}"
                  bindinput="onScheduleContentInput"
                  data-index="{{ index }}"
                />
              </view>
              <view class="delete-schedule-btn" bindtap="deleteScheduleItem" data-index="{{ index }}">
                <image src="/assets/icons/close.svg" mode="aspectFit"></image>
              </view>
            </view>
            <view class="add-schedule-btn" bindtap="addScheduleItem">
              <image src="/assets/icons/add.svg" class="add-icon" mode="aspectFit"></image>
              <text>添加流程</text>
            </view>
          </view>
        </view>

        <!-- 分组权限 -->
        <view class="form-item">
          <view class="form-label">分组权限</view>
          <view class="radio-group">
            <radio-group bindchange="onGroupingPermissionChange">
              <label class="radio-item">
                <radio
                  value="admin"
                  checked="{{ formData.groupingPermission === 'admin' }}"
                  color="{{ 'var(--primary-green-dark)' }}"
                />
                <text class="radio-text">管理员分组</text>
              </label>
              <label class="radio-item">
                <radio
                  value="player"
                  checked="{{ formData.groupingPermission === 'player' }}"
                  color="{{ 'var(--primary-green-dark)' }}"
                />
                <text class="radio-text">球员自由选择</text>
              </label>
            </radio-group>
          </view>
        </view>

        <!-- 是否公开报名 -->
        <view class="form-item">
          <view class="form-label">是否公开报名</view>
          <view class="radio-group">
            <radio-group bindchange="onIsPublicChange">
              <label class="radio-item">
                <radio
                  value="y"
                  checked="{{ formData.isPublic === 'y' }}"
                  color="{{ 'var(--primary-green-dark)' }}"
                />
                <text class="radio-text">公开 (任意人可报名)</text>
              </label>
              <label class="radio-item">
                <radio
                  value="n"
                  checked="{{ formData.isPublic === 'n' }}"
                  color="{{ 'var(--primary-green-dark)' }}"
                />
                <text class="radio-text">仅队内 (仅球队成员)</text>
              </label>
            </radio-group>
          </view>
        </view>
      </view>

      <!-- 提交按钮 -->
      <view class="action-footer">
        <button
          class="create-btn {{ submitting ? 'disabled' : '' }}"
          bindtap="onSubmit"
          disabled="{{ submitting }}"
        >{{ submitting ? '创建中...' : '创建并开启报名' }}</button>
      </view>
    </view>
  </view>
</view>
