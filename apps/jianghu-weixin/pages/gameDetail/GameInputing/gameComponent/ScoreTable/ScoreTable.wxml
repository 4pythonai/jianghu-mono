<view class="score-table-margin"></view>
<view class="score-container">
  <!-- 左侧固定列 -->
  <view class="fixed-column player-column">
    <view class="tb-header tb-header-player">球员</view>
    <scroll-view
      scroll-y
      class="table-body"
      id="playerTable"
      scroll-top="{{ scrollTop }}"
      bindscroll="onPlayerScroll"
    >
      <view class="cell-player" wx:for="{{ players }}" wx:for-item="player" wx:key="user">
        <PlayerInfo index="{{ index }}" player="{{ player }}" />
      </view>
    </scroll-view>
  </view>

  <!-- 主滚动区域 -->
  <scroll-view scroll-x class="main-scroll" id="mainScroll">
    <!-- 中间内容区 -->
    <view
      class="scroll-content"
      style="width: {{ (holeList.length + (holeList.length === 18 ? 3 : 1)) * 80 }}px"
    >
      <!-- 表头 -->
      <view class="tb-header tb-header-holes">
        <!-- 前9洞表头 (1-9) -->
        <view
          wx:for="{{ holeList }}"
          wx:key="unique_key"
          wx:for-item="hole"
          wx:if="{{ holeList.length === 18 ? index < 9 : true }}"
          class="tb-header-hole"
        >
          <view class="hole-name">{{hole.holename}}</view>
          <view class="hole-par">{{hole.par}}</view>
        </view>
        <!-- OUT汇总表头 (仅18洞时，在前9洞后显示) -->
        <view wx:if="{{ holeList.length === 18 }}" class="tb-header-hole tb-header-out">
          <view class="total-text">OUT</view>
        </view>
        <!-- 后9洞表头 (10-18) -->
        <view
          wx:for="{{ holeList }}"
          wx:for-item="hole"
          wx:key="unique_key"
          wx:if="{{ holeList.length === 18 && index >= 9 }}"
          class="tb-header-hole"
        >
          <view class="hole-name">{{hole.holename}}</view>
          <view class="hole-par">{{hole.par}}</view>
        </view>

        <!-- IN汇总表头 (仅18洞时，在后9洞后显示) -->
        <view wx:if="{{ holeList.length === 18 }}" class="tb-header-hole tb-header-in">
          <view class="total-text">IN</view>
        </view>
        <!-- 总分表头 -->
        <view class="tb-header-hole tb-header-total">
          <view class="total-text">TOTAL</view>
        </view>
      </view>

      <!-- 内容行 -->
      <scroll-view
        scroll-y
        class="table-body"
        id="holesTable"
        scroll-top="{{ scrollTop }}"
        bindscroll="onHolesScroll"
        wx:if="{{ displayScores !== null && displayTotals !== null }}"
      >
        <view class="table-row" wx:for="{{ players }}" wx:key="user" wx:for-index="playerIndex">
          <!-- 前9洞 (1-9) -->
          <view
            wx:for="{{holeList}}"
            wx:key="unique_key"
            wx:for-index="holeIndex"
            wx:if="{{ holeList.length === 18 ? holeIndex < 9 : true }}"
            class="cell-score"
          >
            <HoleCell
              playerIndex="{{ playerIndex }}"
              holeIndex="{{ holeIndex }}"
              holeList="{{ holeList }}"
              players="{{ players }}"
              displayScores="{{ displayScores }}"
              bind:cellclick="onCellClick"
            />
          </view>
          <!-- OUT汇总单元格 (仅18洞时，在前9洞后显示) -->
          <view wx:if="{{ holeList.length === 18 }}" class="cell-score cell-out">
            <text
              style="color:#333;font-size:16px;font-weight:bold;"
            >{{displayOutTotals && displayOutTotals[playerIndex] != null ? displayOutTotals[playerIndex] : ''}}</text>
          </view>
          <!-- 后9洞 (10-18) -->
          <view
            wx:for="{{holeList}}"
            wx:key="unique_key"
            wx:for-index="holeIndex"
            wx:if="{{ holeList.length === 18 && holeIndex >= 9 }}"
            class="cell-score"
          >
            <HoleCell
              playerIndex="{{ playerIndex }}"
              holeIndex="{{ holeIndex }}"
              holeList="{{ holeList }}"
              players="{{ players }}"
              displayScores="{{ displayScores }}"
              bind:cellclick="onCellClick"
            />
          </view>
          <!-- IN汇总单元格 (仅18洞时，在后9洞后显示) -->
          <view wx:if="{{ holeList.length === 18 }}" class="cell-score cell-in">
            <text
              style="color:#333;font-size:16px;font-weight:bold;"
            >{{displayInTotals && displayInTotals[playerIndex] != null ? displayInTotals[playerIndex] : ''}}</text>
          </view>
          <!-- 总分单元格 -->
          <view class="cell-score cell-total">
            <text
              style="color:#333;font-size:16px;font-weight:bold;"
            >{{displayTotals && displayTotals[playerIndex] !== undefined ? displayTotals[playerIndex] : ''}}</text>
          </view>
        </view>
      </scroll-view>
      <!-- 数据加载中的占位符，避免表格突然出现 -->
      <scroll-view wx:else scroll-y class="table-body">
        <view class="table-row" wx:for="{{ players }}" wx:key="user" wx:for-index="playerIndex">
          <!-- 前9洞 (1-9) -->
          <view
            wx:for="{{holeList}}"
            wx:key="unique_key"
            wx:for-index="holeIndex"
            wx:if="{{ holeList.length === 18 ? holeIndex < 9 : true }}"
            class="cell-score loading-cell"
          ></view>
          <!-- OUT汇总单元格 (仅18洞时，在前9洞后显示) -->
          <view wx:if="{{ holeList.length === 18 }}" class="cell-score cell-out loading-cell"></view>
          <!-- 后9洞 (10-18) -->
          <view
            wx:for="{{holeList}}"
            wx:key="unique_key"
            wx:for-index="holeIndex"
            wx:if="{{ holeList.length === 18 && holeIndex >= 9 }}"
            class="cell-score loading-cell"
          ></view>
          <!-- IN汇总单元格 (仅18洞时，在后9洞后显示) -->
          <view wx:if="{{ holeList.length === 18 }}" class="cell-score cell-in loading-cell"></view>
          <!-- 总分单元格 -->
          <view class="cell-score cell-total loading-cell"></view>
        </view>
      </scroll-view>
    </view>
  </scroll-view>
</view>

<view class="bottom-action-bar">
  <view class="game-abstract" wx:if="{{gameAbstract}}">
    <text class="abstract-text">{{gameAbstract}}</text>
  </view>

  <view class="button-group">
    <view class="addPlayerBtn" bindtap="showAddPlayerPanel">
      <text class="add-icon">+</text>
    </view>

    <view class="operationBtn" bindtap="showOperationPanel">
      <text class="operation-icon">⋯</text>
    </view>
  </view>
</view>

<!-- 游戏操作面板 -->
<GameOperationPanel
  id="gameOperationPanel"
  bind:optionclick="onOptionClick"
  bind:cancelgame="onCancelGame"
  bind:finishgame="onFinishGame"
/>

<!-- 添加球员面板 -->
<AddPlayerHubPanel id="addPlayerPanel" bind:confirm="onAddPlayerConfirm" />
