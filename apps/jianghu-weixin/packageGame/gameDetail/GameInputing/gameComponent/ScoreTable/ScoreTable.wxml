<template name="holeHeaderCells">
  <!-- 前9洞表头 (1-9) -->
  <view
    wx:for="{{ holeList }}"
    wx:key="unique_key"
    wx:for-item="hole"
    wx:if="{{ holeList.length === 18 ? index < 9 : true }}"
    class="tb-header-hole"
  >
    <view class="hole-name">{{hole.holename}}</view>
    <view class="hole-par">{{hole.par}}</view>
  </view>
  <!-- OUT汇总表头 (仅18洞时，在前9洞后显示) -->
  <view wx:if="{{ holeList.length === 18 }}" class="tb-header-hole tb-header-out">
    <view class="total-text">OUT</view>
  </view>
  <!-- 后9洞表头 (10-18) -->
  <view
    wx:for="{{ holeList }}"
    wx:for-item="hole"
    wx:key="unique_key"
    wx:if="{{ holeList.length === 18 && index >= 9 }}"
    class="tb-header-hole"
  >
    <view class="hole-name">{{hole.holename}}</view>
    <view class="hole-par">{{hole.par}}</view>
  </view>

  <!-- IN汇总表头 (仅18洞时，在后9洞后显示) -->
  <view wx:if="{{ holeList.length === 18 }}" class="tb-header-hole tb-header-in">
    <view class="total-text">IN</view>
  </view>
  <!-- 总分表头 -->
  <view class="tb-header-hole tb-header-total">
    <view class="total-text">TOTAL</view>
  </view>
</template>

<template name="scoreRowCells">
  <!-- 前9洞 (1-9) -->
  <view
    wx:for="{{holeList}}"
    wx:key="unique_key"
    wx:for-index="holeIndex"
    wx:if="{{ holeList.length === 18 ? holeIndex < 9 : true }}"
    class="cell-score"
  >
    <HoleCell
      playerIndex="{{ scoreIndex }}"
      holeIndex="{{ holeIndex }}"
      holeList="{{ holeList }}"
      players="{{ players }}"
      displayScores="{{ displayScores }}"
      bind:cellclick="onCellClick"
    />
  </view>
  <!-- OUT汇总单元格 (仅18洞时，在前9洞后显示) -->
  <view wx:if="{{ holeList.length === 18 }}" class="cell-score cell-out">
    <text
      style="color:#333;font-size:16px;font-weight:bold;"
    >{{outTotals && outTotals[totalIndex] != null ? outTotals[totalIndex] : ''}}</text>
  </view>
  <!-- 后9洞 (10-18) -->
  <view
    wx:for="{{holeList}}"
    wx:key="unique_key"
    wx:for-index="holeIndex"
    wx:if="{{ holeList.length === 18 && holeIndex >= 9 }}"
    class="cell-score"
  >
    <HoleCell
      playerIndex="{{ scoreIndex }}"
      holeIndex="{{ holeIndex }}"
      holeList="{{ holeList }}"
      players="{{ players }}"
      displayScores="{{ displayScores }}"
      bind:cellclick="onCellClick"
    />
  </view>
  <!-- IN汇总单元格 (仅18洞时，在后9洞后显示) -->
  <view wx:if="{{ holeList.length === 18 }}" class="cell-score cell-in">
    <text
      style="color:#333;font-size:16px;font-weight:bold;"
    >{{inTotals && inTotals[totalIndex] != null ? inTotals[totalIndex] : ''}}</text>
  </view>
  <!-- 总分单元格 -->
  <view class="cell-score cell-total">
    <text
      style="color:#333;font-size:16px;font-weight:bold;"
    >{{totals && totals[totalIndex] != null ? totals[totalIndex] : ''}}</text>
  </view>
</template>

<template name="matchResultRowCells">
  <!-- 前9洞 (1-9) -->
  <view
    wx:for="{{holeList}}"
    wx:key="unique_key"
    wx:for-index="holeIndex"
    wx:if="{{ holeList.length === 18 ? holeIndex < 9 : true }}"
    class="cell-score oneball-score-cell"
  >
    <text
      class="oneball-score-text {{matchResults[holeIndex] && matchResults[holeIndex].status === 'lose' ? 'is-loss' : ''}}"
    >{{matchResults[holeIndex] ? matchResults[holeIndex].text : ''}}</text>
  </view>
  <!-- OUT汇总单元格 (仅18洞时，在前9洞后显示) -->
  <view
    wx:if="{{ holeList.length === 18 }}"
    class="cell-score cell-out oneball-score-cell"
  ></view>
  <!-- 后9洞 (10-18) -->
  <view
    wx:for="{{holeList}}"
    wx:key="unique_key"
    wx:for-index="holeIndex"
    wx:if="{{ holeList.length === 18 && holeIndex >= 9 }}"
    class="cell-score oneball-score-cell"
  >
    <text
      class="oneball-score-text {{matchResults[holeIndex] && matchResults[holeIndex].status === 'lose' ? 'is-loss' : ''}}"
    >{{matchResults[holeIndex] ? matchResults[holeIndex].text : ''}}</text>
  </view>
  <!-- IN汇总单元格 (仅18洞时，在后9洞后显示) -->
  <view
    wx:if="{{ holeList.length === 18 }}"
    class="cell-score cell-in oneball-score-cell"
  ></view>
  <!-- 总分单元格 -->
  <view class="cell-score cell-total oneball-score-cell"></view>
</template>

<template name="scoreTableRow">
  <view class="table-row {{rowType === 'score' ? 'oneball-score-row' : ''}}">
    <block wx:if="{{rowType === 'score'}}">
      <template
        is="matchResultRowCells"
        data="{{holeList: holeList, matchResults: matchResults}}"
      />
    </block>
    <block wx:else>
      <template
        is="scoreRowCells"
        data="{{holeList: holeList, scoreIndex: scoreIndex, totalIndex: totalIndex, players: players, displayScores: displayScores, outTotals: outTotals, inTotals: inTotals, totals: totals}}"
      />
    </block>
  </view>
</template>

<template name="loadingRowCells">
  <!-- 前9洞 (1-9) -->
  <view
    wx:for="{{holeList}}"
    wx:key="unique_key"
    wx:for-index="holeIndex"
    wx:if="{{ holeList.length === 18 ? holeIndex < 9 : true }}"
    class="cell-score loading-cell"
  ></view>
  <!-- OUT汇总单元格 (仅18洞时，在前9洞后显示) -->
  <view wx:if="{{ holeList.length === 18 }}" class="cell-score cell-out loading-cell"></view>
  <!-- 后9洞 (10-18) -->
  <view
    wx:for="{{holeList}}"
    wx:key="unique_key"
    wx:for-index="holeIndex"
    wx:if="{{ holeList.length === 18 && holeIndex >= 9 }}"
    class="cell-score loading-cell"
  ></view>
  <!-- IN汇总单元格 (仅18洞时，在后9洞后显示) -->
  <view wx:if="{{ holeList.length === 18 }}" class="cell-score cell-in loading-cell"></view>
  <!-- 总分单元格 -->
  <view class="cell-score cell-total loading-cell"></view>
</template>

<view class="score-table-margin"></view>
<view class="score-container">
  <!-- 左侧固定列 -->
  <view class="fixed-column player-column {{isOneballMode ? 'oneball-column' : ''}}">
    <view class="tb-header tb-header-player">{{isOneballMode ? '组别' : '球员'}}</view>
    <scroll-view
      scroll-y
      class="table-body"
      id="playerTable"
      scroll-top="{{ scrollTop }}"
      bindscroll="onPlayerScroll"
    >
      <block wx:if="{{isOneballMode}}">
        <view class="cell-player" wx:for="{{oneballRows}}" wx:key="key">
          <view wx:if="{{item.type === 'group'}}" class="oneball-player-cell">
            <view class="oneball-avatar-list">
              <view class="oneball-player" wx:for="{{item.players}}" wx:key="user_id">
                <jh-avatar
                  avatar="{{item.avatar}}"
                  show_name="{{item.show_name}}"
                  user_id="{{item.user_id}}"
                  size="mini"
                  avatar_only="{{true}}"
                  clickable="{{false}}"
                />
                <text class="oneball-player-name">{{item.show_name}}</text>
              </view>
            </view>
          </view>
          <view wx:elif="{{item.type === 'score'}}" class="oneball-score-label">
            <text>{{item.label}}</text>
          </view>
        </view>
      </block>
      <block wx:else>
        <view class="cell-player" wx:for="{{ renderPlayers }}" wx:for-item="player" wx:key="user">
          <PlayerInfo index="{{ index }}" player="{{ player }}" />
        </view>
      </block>
    </scroll-view>
  </view>

  <!-- 主滚动区域 -->
  <scroll-view scroll-x enhanced class="main-scroll" id="mainScroll">
    <!-- 中间内容区 -->
    <view
      class="scroll-content"
      style="width: {{ (holeList.length + (holeList.length === 18 ? 3 : 1)) * 80 }}px"
    >
      <!-- 表头 -->
      <view class="tb-header tb-header-holes">
        <template is="holeHeaderCells" data="{{holeList: holeList}}" />
      </view>

      <!-- 内容行 -->
      <scroll-view
        scroll-y
        class="table-body"
        id="holesTable"
        scroll-top="{{ scrollTop }}"
        bindscroll="onHolesScroll"
        wx:if="{{ displayScores !== null && displayTotals !== null }}"
      >
        <block wx:if="{{isOneballMode}}">
          <block wx:for="{{oneballRows}}" wx:key="key" wx:for-index="rowIndex">
            <template
              is="scoreTableRow"
              data="{{rowType: item.type, holeList: holeList, scoreIndex: item.playerIndex, totalIndex: rowIndex, players: renderPlayers, displayScores: oneballDisplayScores, outTotals: oneballRowOutTotals, inTotals: oneballRowInTotals, totals: oneballRowTotals, matchResults: oneballMatchResults}}"
            />
          </block>
        </block>
        <block wx:else>
          <block wx:for="{{ renderPlayers }}" wx:key="user" wx:for-index="playerIndex" wx:for-item="player">
            <template
              is="scoreTableRow"
              data="{{rowType: 'player', holeList: holeList, scoreIndex: playerIndex, totalIndex: playerIndex, players: renderPlayers, displayScores: displayScores, outTotals: displayOutTotals, inTotals: displayInTotals, totals: displayTotals}}"
            />
          </block>
        </block>
      </scroll-view>
      <!-- 数据加载中的占位符，避免表格突然出现 -->
      <scroll-view wx:else scroll-y class="table-body">
        <view class="table-row" wx:for="{{ renderPlayers }}" wx:key="user" wx:for-index="playerIndex">
          <template
            is="loadingRowCells"
            data="{{holeList: holeList}}"
          />
        </view>
      </scroll-view>
    </view>
  </scroll-view>
</view>
