<!--components/ScoreInputPanel/ScoreInputPanel.wxml-->
<wxs src="/utils/image.wxs" module="image" />

<view class="modal-mask" wx:if="{{isVisible}}" bindtap="handleMaskClick">
  <view class="modal-content" catch:tap="preventBubble">
    <view class="panel-container" catch:tap="preventBubble">
      <view class="hole-info-bar">
        <view class="hole-name-container">
          <view class="hole-name-main">{{currentHole.holename}}</view>
        </view>
        <view class="hole-details-wrapper">
          <view class="hole-detail">
            <text class="hole-detail-label">PAR</text>
            <text class="hole-detail-value">{{currentHole.par}}</text>
          </view>
          <view class="hole-detail-divider"></view>
          <view class="hole-detail">
            <text class="hole-detail-label">YARDS</text>
            <text class="hole-detail-value">{{currentPlayerDistance || ''}}</text>
          </view>
          <view class="hole-detail-divider"></view>
          <view class="hole-detail">
            <text class="hole-detail-label">TEE</text>
            <view class="hole-tee-detail">
              <text class="hole-detail-value tee-text">{{currentPlayerTee || ''}}</text>
              <view class="tee-indicator tee-{{currentPlayerTee}}"></view>
            </view>
          </view>
        </view>
      </view>

      <view class="main-content">
        <view class="player-list-container {{isOneballMode ? 'oneball' : ''}}">
          <view class="oneball-group-list" wx:if="{{isOneballMode}}">
            <view
              class="group-card {{activeGroupKey === 'A' ? 'active' : ''}}"
              wx:if="{{oneballGroups.A.length}}"
              data-group="A"
              bindtap="switchGroup"
            >
              <text class="group-card-title">A组</text>
              <text
                class="group-card-score-large"
              >{{oneballGroups.A.length ? (localScores[oneballGroups.A[0].index] ? localScores[oneballGroups.A[0].index].score : '') : ''}}</text>
              <view class="group-card-avatars">
                <image
                  class="group-card-avatar"
                  wx:for="{{oneballGroups.A}}"
                  wx:key="user_id"
                  src="{{image.imageUrl(item.avatar)}}"
                />
              </view>
            </view>
            <view
              class="group-card {{activeGroupKey === 'B' ? 'active' : ''}}"
              wx:if="{{oneballGroups.B.length}}"
              data-group="B"
              bindtap="switchGroup"
            >
              <text class="group-card-title">B组</text>
              <text
                class="group-card-score-large"
              >{{oneballGroups.B.length ? (localScores[oneballGroups.B[0].index] ? localScores[oneballGroups.B[0].index].score : '') : ''}}</text>
              <view class="group-card-avatars">
                <image
                  class="group-card-avatar"
                  wx:for="{{oneballGroups.B}}"
                  wx:key="user_id"
                  src="{{image.imageUrl(item.avatar)}}"
                />
              </view>
            </view>
          </view>
          <scroll-view
            class="player-list-scroll"
            wx:else
            scroll-y="{{players.length > 4}}"
            show-scrollbar="false"
          >
            <view
              class="player-item {{index === activePlayerIndex ? 'active' : ''}} {{item.user_id == currentUserId ? 'is-current-user' : ''}}"
              wx:for="{{players}}"
              wx:key="index"
              bindtap="switchPlayer"
              data-index="{{index}}"
            >
              <image class="player-avatar" src="{{image.imageUrl(item.avatar)}}" />
              <view
                class="player-score-badge"
              >{{localScores[index] ? localScores[index].score : ''}}</view>
            </view>
          </scroll-view>
        </view>

        <view class="scoring-area-container">
          <view class="scoring-area">
            <view class="score-row">
              <view class="score-label">
                <text class="score-label-cn">成绩</text>
                <text class="score-label-en">Score</text>
              </view>
              <view class="score-control">
                <view
                  class="control-btn minus"
                  data-type="score"
                  data-amount="-1"
                  bind:tap="changeScore"
                >-</view>
                <text class="score-value">{{localScores[activePlayerIndex].score}}</text>
                <view
                  class="control-btn plus"
                  data-type="score"
                  data-amount="1"
                  bind:tap="changeScore"
                >+</view>
              </view>
            </view>
            <view class="score-row">
              <view class="score-label">
                <text class="score-label-cn">推杆</text>
                <text class="score-label-en">Putts</text>
              </view>
              <view class="score-control">
                <view
                  class="control-btn minus"
                  data-type="putts"
                  data-amount="-1"
                  bind:tap="changeScore"
                >-</view>
                <text class="score-value">{{localScores[activePlayerIndex].putts}}</text>
                <view
                  class="control-btn plus"
                  data-type="putts"
                  data-amount="1"
                  bind:tap="changeScore"
                >+</view>
              </view>
            </view>
            <view class="score-row">
              <view class="score-label">
                <text class="score-label-cn">罚杆</text>
                <text class="score-label-en">Pen</text>
              </view>
              <view class="score-control">
                <view
                  class="control-btn minus"
                  data-type="penalty_strokes"
                  data-amount="-1"
                  bind:tap="changeScore"
                >-</view>
                <text class="score-value">{{localScores[activePlayerIndex].penalty_strokes || 0}}</text>
                <view
                  class="control-btn plus"
                  data-type="penalty_strokes"
                  data-amount="1"
                  bind:tap="changeScore"
                >+</view>
              </view>
            </view>
            <view class="score-row">
              <view class="score-label">
                <text class="score-label-cn">沙坑</text>
                <text class="score-label-en">Sand</text>
              </view>
              <view class="score-control">
                <view
                  class="control-btn minus"
                  data-type="sand_save"
                  data-amount="-1"
                  bind:tap="changeScore"
                >-</view>
                <text class="score-value">{{localScores[activePlayerIndex].sand_save || 0}}</text>
                <view
                  class="control-btn plus"
                  data-type="sand_save"
                  data-amount="1"
                  bind:tap="changeScore"
                >+</view>
              </view>
            </view>

            <view class="tee-shot-options">
              <view
                class="shot-option {{localScores[activePlayerIndex].tee_shot_direction === 'center' ? 'active' : ''}}"
                data-direction="center"
                bindtap="handleTeeShotDirection"
              >
                <view class="shot-icon-wrapper center">
                  <view class="target-ring"></view>
                  <view class="target-dot"></view>
                </view>
                <text class="shot-label">上球道</text>
              </view>
              <view
                class="shot-option {{localScores[activePlayerIndex].tee_shot_direction === 'left' ? 'active' : ''}}"
                data-direction="left"
                bindtap="handleTeeShotDirection"
              >
                <view class="shot-icon-wrapper arrow">
                  <image class="arrow-icon" src="/assets/icons/icons8-left-arrow-48.png" />
                </view>
                <text class="shot-label">拉左</text>
              </view>
              <view
                class="shot-option {{localScores[activePlayerIndex].tee_shot_direction === 'right' ? 'active' : ''}}"
                data-direction="right"
                bindtap="handleTeeShotDirection"
              >
                <view class="shot-icon-wrapper arrow">
                  <image class="arrow-icon" src="/assets/icons/icons8-right-arrow-48.png" />
                </view>
                <text class="shot-label">拉右</text>
              </view>
              <view
                class="shot-option {{localScores[activePlayerIndex].tee_shot_direction === 'long' ? 'active' : ''}}"
                data-direction="long"
                bindtap="handleTeeShotDirection"
              >
                <view class="shot-icon-wrapper arrow">
                  <image class="arrow-icon" src="/assets/icons/icons8-up-arrow-48.png" />
                </view>
                <text class="shot-label">打穿</text>
              </view>
              <view
                class="shot-option {{localScores[activePlayerIndex].tee_shot_direction === 'short' ? 'active' : ''}}"
                data-direction="short"
                bindtap="handleTeeShotDirection"
              >
                <view class="shot-icon-wrapper arrow">
                  <image class="arrow-icon" src="/assets/icons/icons8-down-arrow-48.png" />
                </view>
                <text class="shot-label">打短</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="modal-actions">
      <button class="modal-btn cancel" bind:tap="handleClear" disabled="{{isSaving}}">
        <view class="btn-text">
          <text class="btn-main">清除</text>
          <text class="btn-sub"></text>
        </view>
      </button>
      <button class="modal-btn confirm" bind:tap="handleConfirm" disabled="{{isSaving}}">
        <view class="btn-text" wx:if="{{!isSaving}}">
          <text class="btn-main">确定</text>
          <text class="btn-sub"></text>
        </view>
        <text class="btn-saving" wx:else>保存中...</text>
      </button>
    </view>
  </view>
</view>
