# 用户/好友/关注体系设计

## 一、用户类型体系

### 用户类型流转

```mermaid
flowchart LR
    WX[微信登录] --> G[游客用户 g]
    G -->|绑定手机号| A[正式用户 a]
    N[非注册用户 n] -->|手工认领| A
    H[半注册用户 h] -->|绑定手机号自动合并| A
```

### 用户类型说明

| 类型 | status | 创建方式 | 权限 |
|------|--------|----------|------|
| 游客用户 | `g` | 微信登录，未绑定手机号 | 只能围观比赛 |
| 正式用户 | `a` | 绑定手机号后 | 完整功能（创建比赛、建球队等） |
| 非注册用户 | `n` | 他人手工添加（仅名称，无手机号） | 无法登录，需手工认领 |
| 半注册用户 | `h` | 他人替报名创建（名称+手机号） | 无法登录，绑定手机号时自动合并 |
| 已合并用户 | `m` | 非注册/半注册用户被认领后 | 数据已迁移，仅保留记录 |

### 非注册用户 vs 半注册用户

| 类型 | 有名称 | 有手机号 | 合并方式 |
|------|--------|----------|----------|
| 非注册用户(n) | ✓ | ✗ | 点击头像认领，或同组用户手工替换 |
| 半注册用户(h) | ✓ | ✓ | 用户绑定手机号时系统自动匹配合并 |

### 保留游客用户的原因

- **降低门槛**：用户可以先微信登录"逛逛"，围观比赛结果
- **渐进转化**：等用户想参赛/创建比赛时，再引导绑定手机号
- **灵活围观**：对于只想看朋友比赛结果的用户，不强制绑定

### 用户类型判断逻辑

```plain
判断用户类型（通过 status 字段）：
- status='g' → 游客用户 (guest)
- status='a' → 正式用户 (active)
- status='n' → 非注册用户 (non-registered)
- status='h' → 半注册用户 (half-registered)
- status='m' → 已合并用户 (merged)

判断是否禁用（通过 disabled_at 字段）：
- disabled_at IS NOT NULL → 已禁用
- disabled_at IS NULL → 正常
```

### 禁用机制

**禁用与用户类型分离**：禁用状态通过独立的 `disabled_at` 字段标记，不影响用户的原始类型。解禁后用户类型自动恢复。

**禁用场景**：
+ 用户违规（发布不当内容、恶意行为等）
+ 账号异常（疑似被盗、批量注册等）
+ 用户主动申请注销

**禁用效果**：
+ 无法登录
+ 无法被搜索
+ 无法被新用户关注
+ 已有的粉丝关系保留，但粉丝无法查看其内容

**解禁**：将 `disabled_at` 置为 NULL，用户恢复原有类型和权限。

### 用户表设计 `t_user`

```sql
CREATE TABLE `t_user` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `openid` VARCHAR(64) DEFAULT NULL COMMENT '微信openid',
  `unionid` VARCHAR(64) DEFAULT NULL COMMENT '微信unionid',
  `mobile` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `wx_name` VARCHAR(100) DEFAULT NULL COMMENT '微信名称（系统同步）',
  `show_name` VARCHAR(100) NOT NULL DEFAULT '' COMMENT '显示名称（用户可修改）',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像',
  `status` CHAR(1) DEFAULT 'g' COMMENT 'g:游客 a:正式用户 n:非注册用户 h:半注册用户 m:已合并',
  `disabled_at` DATETIME DEFAULT NULL COMMENT '禁用时间，非NULL表示已禁用',
  `created_by` INT DEFAULT NULL COMMENT '非注册/半注册用户的创建者ID',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_openid` (`openid`),
  UNIQUE KEY `uk_mobile` (`mobile`)
) COMMENT='用户表';
```

**关于 UNIQUE 约束与 NULL**：

+ `openid` 和 `mobile` 字段设置为 UNIQUE，但允许 NULL
+ MySQL 中多个 NULL 值不违反 UNIQUE 约束，这是预期行为
+ 非注册用户(n)和半注册用户(h)没有 openid
+ 非注册用户(n)没有 mobile；已合并用户(m)的 mobile 会被置空

---


### 字段定义

| 字段 | 来源 | 可编辑 | 说明 |
|------|------|--------|------|
| `wx_name` | 微信授权 | 否（系统同步） | 每次微信登录时自动更新 |
| `show_name` | 用户输入 | 是 | 用户可随时修改，默认值=wx_name |
| `remark_name` | 他人设置 | 是 | A给B设置的名字，仅A可见（存在 user_remark 表） |

### 显示优先级

```plain
remark_name > show_name > wx_name
```

### 各场景下的名称处理

| 场景 | wx_name | show_name |
|------|---------|--------------|
| 微信登录（首次） | 从微信获取 | 同 wx_name |
| 微信登录（后续） | 自动更新 | 保持不变（除非用户主动修改） |
| 创建非注册用户 | NULL | 创建者输入的名称 |
| 创建半注册用户 | NULL | 创建者输入的名称 |
| 非注册/半注册用户被合并 | 从微信获取 | **用 wx_name 覆盖** |

---

## 三、替朋友报名流程

### 流程图

```mermaid
flowchart TD
    A[替朋友报名] --> B{输入信息}
    B -->|仅输入名称| C[创建非注册用户]
    C --> D[建立互相关注]
    D --> E[添加到比赛]

    B -->|输入名称+手机号| F{查询手机号}
    F -->|不存在| G[创建半注册用户]
    G --> D

    F -->|正式用户存在| H[显示用户信息]
    H --> I{用户确认}
    I -->|是这个人| J[建立互相关注]
    J --> E
    I -->|不是| K[提示重新输入]

    F -->|半注册用户存在| L[直接使用该半注册用户]
    L --> D

    F -->|游客用户存在| H
```

### 场景处理规则

| 场景 | 处理方式 |
|------|----------|
| 仅输入名称 | 创建非注册用户(status=n)，建立互相关注 |
| 输入名称+手机号，手机号不存在 | 创建半注册用户(status=h)，建立互相关注 |
| 手机号属于正式用户(a) | 展示头像+名称，让用户确认是否就是这个人 |
| 手机号属于半注册用户(h) | 直接使用已存在的半注册用户，建立互相关注 |
| 手机号属于游客用户(g) | 同正式用户，展示确认 |

### 替朋友报名 = 建立互相关注

```sql
-- A 替 B 报名后，自动插入双向关注（互关=好友关系）
INSERT INTO t_user_follow (user_id, target_id) VALUES (A, B);
INSERT INTO t_user_follow (user_id, target_id) VALUES (B, A);
```

注意：对于非注册用户(n)和半注册用户(h)，B->A 的关注记录也会创建，合并后保留。

---

## 四、用户合并逻辑

### 非注册用户(n)合并 - 手工认领

非注册用户只有名称没有手机号，无法通过手机号自动匹配，需要手工认领：

1. **点击头像认领**：点击非注册用户头像，显示"认领"按钮
2. **同组用户替换**：与非注册用户同组的正式用户可以手工替换

认领/替换后执行数据迁移：

1. 比赛记录、成绩数据 → 迁移到认领者
2. 被他人关注的关系 → target_id 改为认领者（**保留 is_special 特别关注状态**）
3. 关注他人的关系 → target_id 改为认领者（保留互关）
4. 他人对其的备注名 → target_id 改为认领者
5. **名称处理**：`show_name = wx_name`（用微信名称覆盖）
6. 将非注册用户的 status 改为 'm'（已合并）

### 半注册用户(h)合并 - 自动匹配

当用户A绑定手机号X时：

1. 查找是否存在 mobile=X 且 status='h' 的半注册用户B
2. 如果存在，执行数据迁移：
    - 比赛记录、成绩数据 → 迁移到A
    - B被他人关注的关系 → target_id 改为A（**保留 is_special 特别关注状态**）
    - B关注他人的关系 → target_id 改为A（保留半注册用户建立的互关）
    - 他人对B的备注名 → target_id 改为A（备注名内容保持不变）
3. **名称处理**：`show_name = wx_name`（用微信名称覆盖半注册时的名称）
4. 将B的 status 改为 'm'（已合并），mobile 置空（释放手机号）
5. A绑定手机号X，完成合并

---

## 五、关注/好友体系

### 关系说明

```plain
A 关注 B  →  A是B的粉丝，B是A的关注对象
B 也关注 A  →  互相关注 = 好友关系
```

### 关注的前置条件

| 关注者 | 被关注者 | 是否允许 | 说明 |
|--------|----------|----------|------|
| 正式用户(a) | 正式用户(a) | ✓ | 正常关注 |
| 正式用户(a) | 游客用户(g) | ✓ | 可以关注游客 |
| 正式用户(a) | 非注册用户(n) | ✓ | 可以关注，认领后自动迁移到正式用户 |
| 正式用户(a) | 半注册用户(h) | ✓ | 可以关注，合并后自动迁移到正式用户 |
| 正式用户(a) | 已禁用用户 | ✗ | disabled_at IS NOT NULL 的用户不可被关注 |
| 正式用户(a) | 已合并用户(m) | ✗ | 已合并用户不可被关注 |
| 游客用户(g) | 任何用户 | ✗ | 游客不能主动关注他人 |
| 非注册用户(n) | 任何用户 | 特殊 | 仅通过"替朋友报名"自动建立互关 |
| 半注册用户(h) | 任何用户 | 特殊 | 仅通过"替朋友报名"自动建立互关 |

### 关注表设计 `t_user_follow`

```sql
CREATE TABLE `t_user_follow` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `user_id` INT NOT NULL COMMENT '关注者',
  `target_id` INT NOT NULL COMMENT '被关注者',
  `is_special` CHAR(1) DEFAULT 'n' COMMENT 'y:特别关注 n:普通关注',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_follow` (`user_id`, `target_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_target` (`target_id`)
) COMMENT='关注关系表';
```

### 特别关注

用户可以将已关注的人标记为"特别关注"，用于：

+ 列表中优先展示
+ 快速筛选查找

### 查询好友（互关）

```sql
-- 查询用户A的好友列表（互相关注）
SELECT u.* FROM user u
WHERE u.id IN (
  SELECT f1.target_id FROM t_user_follow f1
  INNER JOIN t_user_follow f2
    ON f1.user_id = f2.target_id AND f1.target_id = f2.user_id
  WHERE f1.user_id = :userId
);
```

---

## 六、备注名

用户可以给**已关注的人**设置备注名（类似微信备注功能）。

| 类型 | 说明 | 可见范围 |
|------|------|----------|
| **显示名称** | 用户自己设置的名字 | 所有人可见 |
| **备注名** | A给B设置的名字 | 只有A自己可见 |

**显示优先级**：`remark_name` > `show_name` > `wx_name`

**用户合并**：合并后 show_name 被 wx_name 覆盖，但他人设置的备注名保留

**取消关注时**：保留备注名记录，重新关注后自动恢复显示

### 备注名表设计 `t_user_remark`

```sql
CREATE TABLE `t_user_remark` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `user_id` INT NOT NULL COMMENT '设置者',
  `target_id` INT NOT NULL COMMENT '被备注者',
  `remark_name` VARCHAR(50) NOT NULL COMMENT '备注名',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_remark` (`user_id`, `target_id`),
  KEY `idx_target` (`target_id`)
) COMMENT='用户备注名表';
```

### 显示名称逻辑

```plain
获取用户B的显示名称（对A而言）：
1. 查询 user_remark 中 A 对 B 的 remark_name
2. 如果有 remark_name → 返回 remark_name
3. 如果没有 → 返回 B 的 show_name
```

---

## 七、拉黑体系

### 黑名单表 `t_user_block`

```sql
CREATE TABLE `t_user_block` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `user_id` INT NOT NULL COMMENT '操作者',
  `blocked_id` INT NOT NULL COMMENT '被拉黑者',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_block` (`user_id`, `blocked_id`),
  KEY `idx_blocked` (`blocked_id`)
) COMMENT='黑名单表';
```

### 拉黑效果

当 A 拉黑 B 时：

+ B **无法**查看 A 的：比赛、历史成绩、动态
+ B **无法**关注 A
+ **双向解除关注**：A 对 B 的关注、B 对 A 的关注都会自动删除
+ A 对 B 的备注名保留（方便识别），B 对 A 的备注名删除

### 取消拉黑

+ 取消拉黑后，双方需要**重新关注**才能恢复好友关系
+ 之前的关注关系不会自动恢复

---

## 八、隐私设置

### 隐私设置表 `t_user_privacy`

```sql
CREATE TABLE `t_user_privacy` (
  `user_id` INT PRIMARY KEY,
  `mobile_searchable` CHAR(1) DEFAULT 'y' COMMENT 'y:可被搜索 n:禁止',
  `profile_visible` CHAR(1) DEFAULT 'y' COMMENT 'y:主页对陌生人可见 n:隐藏 [VIP]',
  `game_history_visible` CHAR(1) DEFAULT 'y' COMMENT 'y:比赛记录对陌生人可见 n:隐藏 [VIP]',
  `allow_stranger_follow` CHAR(1) DEFAULT 'y' COMMENT 'y:允许陌生人关注 n:禁止 [VIP]',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT='隐私设置表';
```


## 九、添加关注的场景

| 场景 | 入口 | 说明 |
|------|------|------|
| 搜索手机号 | 通讯录/搜索页 | 需对方开启手机号搜索 |
| 扫码 | 扫一扫 | 扫描用户二维码 |
| 比赛中 | 比赛详情页 | 点击参赛者头像 → 关注 |
| 广场围观 | 广场/比赛列表 | 点击任意用户 → 关注 |
| 好友推荐 | 推荐列表 | 基于共同球友等推荐 |
| **替朋友报名** | 报名页 | 自动建立互相关注 |

---

## 十、边缘情况处理

| 情况 | 处理 |
|------|------|
| A 已经关注 B，再替 B 报名 | 跳过已存在的关注记录，不重复插入 |
| A 替 B 报名，B 已拉黑 A | 不建立关注关系，仅添加到比赛（或提示无法操作） |
| A 替 B 报名，手机号输错（属于 C） | 确认界面展示 C 的信息，A 发现不对可重新输入 |
| 非注册/半注册用户合并时已有互关 | 保留关注关系，不重复创建 |

---


## 附录：关系图总览

```plain
┌─────────────────────────────────────────────┐
│                  用户类型                    │
├─────────────────────────────────────────────┤
│  游客用户 ──绑定手机号──▶ 正式用户            │
│                              ▲              │
│  非注册用户 ───手工认领──────┤               │
│  半注册用户 ───自动合并──────┘               │
│                                             │
│  任意用户 ──disabled_at──▶ 禁用状态（可恢复） │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│                  社交关系                    │
├─────────────────────────────────────────────┤
│   A ──关注──▶ B     A是B的粉丝              │
│   A ──特别关注──▶ B  优先展示、快速筛选       │
│   B ──关注──▶ A     互关=好友               │
│   B ──拉黑──▶ A     B无法看A的任何内容       │
│                                             │
│   A ──替B报名──▶    自动建立互相关注         │
└─────────────────────────────────────────────┘
```
