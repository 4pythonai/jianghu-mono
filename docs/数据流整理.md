# 数据流整理文档

## 概述

本文档记录了项目中重复配置的整理过程，通过创建统一的常量配置文件来避免重复定义，提高代码的可维护性。

## 问题分析

在项目中发现以下重复配置：

1. **高尔夫球成绩类型配置**：
   - `BetterThanBirdie`、`Birdie`、`Par`、`WorseThanPar`
   - 在多个文件中重复定义中文标签映射
   - 在多个组件中重复定义键名数组

2. **8421游戏配置**：
   - 默认配置在多个地方重复定义
   - 预设配置选项分散在不同文件中

3. **吃肉规则配置**：
   - 选项数组在多个地方重复定义
   - 数值范围配置重复

4. **游戏类型映射**：
   - 游戏类型配置在多个文件中重复定义

## 解决方案

### 1. 创建统一常量配置文件

创建了 `utils/gameConstants.js` 文件，统一管理所有游戏相关的常量配置：

```javascript
// 高尔夫球成绩类型常量
export const GOLF_SCORE_TYPES = {
    LABELS: {
        'BetterThanBirdie': '帕以上',
        'Birdie': '鸟',
        'Par': '帕',
        'WorseThanPar': '鸟以下'
    },
    KEYS: ['BetterThanBirdie', 'Birdie', 'Par', 'WorseThanPar'],
    DEFAULT_EATING_RANGE: {
        "BetterThanBirdie": 2,
        "Birdie": 2,
        "Par": 1,
        "WorseThanPar": 0
    }
};

// 8421游戏配置常量
export const GAME_8421_CONFIG = {
    DEFAULT_8421_CONFIG: {
        "Birdie": 8,
        "Par": 4,
        "Par+1": 2,
        "Par+2": 1
    },
    PRESET_CONFIGS: {
        '6321': { "Birdie": 6, "Par": 3, "Par+1": 2, "Par+2": 1 },
        '8421': { "Birdie": 8, "Par": 4, "Par+1": 2, "Par+2": 1 },
        // ... 更多预设配置
    }
};

// 吃肉规则配置常量
export const EATMEAT_CONFIG = {
    MEAT_VALUE_OPTIONS: [
        { label: '肉算1分', value: 'MEAT_AS_1' },
        { label: '分值翻倍', value: 'SINGLE_DOUBLE' },
        { label: '分值连续翻倍', value: 'CONTINUE_DOUBLE' }
    ],
    TOP_OPTIONS: [
        { label: '不封顶', value: 10000000 },
        { label: 'X分封顶', value: 'custom' }
    ],
    RANGES: {
        EAT_VALUE: Array.from({ length: 20 }, (_, i) => i + 1),
        TOP_SCORE: Array.from({ length: 20 }, (_, i) => i + 1)
    }
};
```

### 2. 提供工具函数

创建了 `GameConstantsUtils` 工具函数，提供便捷的配置获取方法：

```javascript
export const GameConstantsUtils = {
    getScoreTypeLabel(key) {
        return GOLF_SCORE_TYPES.LABELS[key] || key;
    },
    getScoreTypeKeys() {
        return GOLF_SCORE_TYPES.KEYS;
    },
    getDefaultEatingRange() {
        return { ...GOLF_SCORE_TYPES.DEFAULT_EATING_RANGE };
    },
    getDefault8421Config() {
        return { ...GAME_8421_CONFIG.DEFAULT_8421_CONFIG };
    },
    getGameTypeConfig(gameType) {
        return GAME_TYPE_MAP[gameType] || null;
    }
};
```

## 修改的文件

### 1. 新增文件
- `utils/gameConstants.js` - 统一常量配置文件

### 2. 修改的文件
- `components/Gamble/8421_configItems/eatmeat/eatmeat.js` - 使用统一常量配置
- `stores/gamble/4p/4p-8421/gamble_4P_8421_Store.js` - 使用统一常量配置
- `utils/ruleParser/rule_4p_8421.js` - 使用统一常量配置

## 数据流结构

### 吃肉规则数据流

```
用户操作 → eatmeat组件 → G_4P_8421_Store → rule_4p_8421解析器 → 显示
```

1. **用户操作**：在 `eatmeat` 组件中选择配置
2. **组件处理**：使用统一的 `EATMEAT_CONFIG` 常量
3. **Store更新**：调用 `updateEatmeatRule` 方法
4. **数据解析**：`rule_4p_8421` 使用统一的 `GOLF_SCORE_TYPES` 常量
5. **显示结果**：在界面上显示解析后的配置信息

### 8421游戏配置数据流

```
用户操作 → PlayerIndicator组件 → gameStore → 运行时配置 → 游戏逻辑
```

1. **用户操作**：在 `PlayerIndicator` 组件中配置球员
2. **组件处理**：使用统一的 `GAME_8421_CONFIG` 常量
3. **Store更新**：更新 `val8421_config` 数据
4. **运行时配置**：在游戏运行时使用配置
5. **游戏逻辑**：根据配置计算得分

## 优势

### 1. 代码复用
- 消除了重复的配置定义
- 统一的配置来源，避免不一致

### 2. 维护性提升
- 配置修改只需要在一个地方进行
- 减少了代码冗余

### 3. 类型安全
- 统一的常量定义，减少拼写错误
- 更好的IDE支持和代码提示

### 4. 扩展性
- 新增配置只需要在常量文件中添加
- 工具函数提供了便捷的扩展接口

## 使用示例

### 在组件中使用

```javascript
import { GOLF_SCORE_TYPES, EATMEAT_CONFIG, GameConstantsUtils } from '../../utils/gameConstants.js'

Component({
  data: {
    // 使用统一配置
    eatRangeLabels: GOLF_SCORE_TYPES.LABELS,
    eatRangeKeys: GOLF_SCORE_TYPES.KEYS,
    meatValueOptions: EATMEAT_CONFIG.MEAT_VALUE_OPTIONS.map(item => item.label),
    eating_range: GameConstantsUtils.getDefaultEatingRange()
  }
})
```

### 在Store中使用

```javascript
import { GameConstantsUtils } from '../../utils/gameConstants.js'

export const Store = observable({
  eating_range: GameConstantsUtils.getDefaultEatingRange(),
  
  resetAllRules: action(function () {
    this.eating_range = GameConstantsUtils.getDefaultEatingRange();
  })
})
```

### 在解析器中使用

```javascript
import { GOLF_SCORE_TYPES } from './gameConstants.js'

function parseEatmeatConfig(item) {
  const eatDetails = GOLF_SCORE_TYPES.KEYS.map(key => {
    const value = eatRangeObj[key];
    const label = GOLF_SCORE_TYPES.LABELS[key];
    return `${label}${value}个`;
  }).join('、');
}
```

## 后续优化建议

1. **继续整理其他重复配置**：
   - 扣分规则配置
   - 顶洞规则配置
   - 游戏类型配置

2. **添加类型定义**：
   - 为常量配置添加TypeScript类型定义
   - 提供更好的类型检查

3. **配置验证**：
   - 添加配置验证函数
   - 确保配置数据的有效性

4. **国际化支持**：
   - 为中文标签添加国际化支持
   - 支持多语言切换

## 总结

通过创建统一的常量配置文件，我们成功整理了项目中的重复配置，提高了代码的可维护性和一致性。这种模式可以继续应用到项目的其他部分，进一步优化代码结构。 