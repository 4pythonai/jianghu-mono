var isOutRange = function (x1, y1, x2, y2, x3, y3) {
    return x1 < 0 || x1 >= y1 || x2 < 0 || x2 >= y2 || x3 < 0 || x3 >= y3
};

var sortCore = function (sKey, eKey, st) {
    var _ = st.baseData;

    var excludeFix = function (cKey, type) {
        if (st.list[cKey] && st.list[cKey].fixed) {
            type ? --cKey : ++cKey;
            return excludeFix(cKey, type);
        }
        return cKey;
    }

    // å…ˆè·å–åˆ° endKey å¯¹åº”çš„ realKey, é˜²æ­¢ä¸‹é¢æ’åºè¿‡ç¨‹ä¸­è¯¥ realKey è¢«ä¿®æ”¹
    var endRealKey = -1;
    st.list.forEach(function (item) {
        if (item.sortKey === eKey) endRealKey = item.realKey;
    });

    return st.list.map(function (item) {
        if (item.fixed) return item;
        var cKey = item.sortKey;
        var rKey = item.realKey;

        if (sKey < eKey) {
            // æ­£åºæ‹–åŠ¨
            if (cKey > sKey && cKey <= eKey) {
                --rKey;
                cKey = excludeFix(--cKey, true);
            } else if (cKey === sKey) {
                rKey = endRealKey;
                cKey = eKey;
            }
        } else if (sKey > eKey) {
            // å€’åºæ‹–åŠ¨
            if (cKey >= eKey && cKey < sKey) {
                ++rKey
                cKey = excludeFix(++cKey, false);
            } else if (cKey === sKey) {
                rKey = endRealKey;
                cKey = eKey;
            }
        }

        if (item.sortKey !== cKey) {
            item.tranX = (cKey % _.columns) * (100 / _.columns) + "%";
            item.tranY = Math.floor(cKey / _.columns) * 100 + "%";
            item.sortKey = cKey;
            item.realKey = rKey;
        }

        return item;
    });
}

var longPress = function (event, ownerInstance) {
    var index = event.currentTarget.dataset.index;
    var st = ownerInstance.getState();

    // å¦‚æœæ˜¯å›ºå®šé¡¹ï¼Œä¸å…è®¸æ‹–æ‹½
    if (st.list[index].fixed) return;

    var mTouch = event.changedTouches[0];
    if (!mTouch) return;

    // åˆå§‹åŒ–æ‹–æ‹½çŠ¶æ€
    st.dragging = true;
    st.cur = index;
    st.sId = mTouch.identifier;

    // æ ‡è®°å½“å‰æ‹–æ‹½é¡¹
    st.list[index].dragging = true;

    // è§¦å‘éœ‡åŠ¨åé¦ˆ
    ownerInstance.callMethod("vibrate");

    // é€šçŸ¥ç»„ä»¶æ‹–æ‹½å¼€å§‹
    ownerInstance.callMethod("onDragStart", { index: index });

    console.log('ğŸ¯ å¼€å§‹æ‹–æ‹½hole:', index, st.list[index].data.holename);
};

var touchMove = function (event, ownerInstance) {
    var ins = event.instance;
    var st = ownerInstance.getState();
    var _ = st.baseData;

    var mTouch = event.changedTouches[0];
    if (!mTouch) return;

    if (!st.dragging) return;

    // å¦‚æœä¸æ˜¯åŒä¸€ä¸ªè§¦å‘ç‚¹åˆ™è¿”å›
    if (st.sId !== mTouch.identifier) return;

    // è®¡ç®—ä½ç§»
    var tranX = mTouch.pageX - (_.itemWidth / 2 + _.wrapLeft);
    var tranY = mTouch.pageY - (_.itemHeight / 2 + _.wrapTop);

    // è®¾ç½®å½“å‰æ¿€æ´»å…ƒç´ åç§»é‡
    ins.setStyle({
        'transform': 'translate3d(' + tranX + 'px, ' + tranY + 'px, 0)'
    })

    var startKey = st.list[st.cur].sortKey;
    var curX = Math.round(tranX / _.itemWidth);
    var curY = Math.round(tranY / _.itemHeight);
    var endKey = curX + _.columns * curY;

    // é™åˆ¶åœ¨æœ‰æ•ˆèŒƒå›´å†…
    if (endKey < 0) endKey = 0;
    if (endKey >= st.list.length) endKey = st.list.length - 1;

    // ç›®æ ‡é¡¹æ˜¯å›ºå®šé¡¹åˆ™è¿”å›
    var item = st.list[endKey];
    if (item && item.fixed) return;

    // è¶…å‡ºèŒƒå›´æ£€æµ‹
    if (isOutRange(curX, _.columns, curY, _.rows, endKey, st.list.length)) return;

    if (startKey === endKey) return;

    // æ‰§è¡Œæ’åº
    st.list = sortCore(startKey, endKey, st);

    console.log('ğŸ“ æ‹–æ‹½é¢„è§ˆ: ä»ä½ç½®', startKey, 'åˆ°ä½ç½®', endKey);
};

var touchEnd = function (event, ownerInstance) {
    var st = ownerInstance.getState();

    if (!st.dragging) return;

    var index = st.cur;

    // é‡ç½®æ‹–æ‹½çŠ¶æ€
    st.dragging = false;
    st.list[index].dragging = false;
    st.cur = -1;
    st.sId = "";

    // é€šçŸ¥ç»„ä»¶æ‹–æ‹½ç»“æŸ
    ownerInstance.callMethod("onDragEnd", {
        index: index,
        newOrder: st.list
    });

    console.log('ğŸ æ‹–æ‹½ç»“æŸ');
};

var listObserver = function (newList, oldList, ownerInstance) {
    if (newList.length === 0) return;

    var st = ownerInstance.getState();
    if (!st) return;

    st.list = newList;
};

var baseDataObserver = function (newData, oldData, ownerInstance) {
    if (!newData) return;

    var st = ownerInstance.getState();
    if (!st) return;

    st.baseData = newData;
};

module.exports = {
    longPress: longPress,
    touchMove: touchMove,
    touchEnd: touchEnd,
    listObserver: listObserver,
    baseDataObserver: baseDataObserver
};