<!-- 用户规则编辑/新建页面 - 重构版 -->
<view class="user-rule-edit-container">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-text">初始化中...</view>
  </view>

  <!-- 主要内容 -->
  <view wx:else class="main-content">
    <!-- 页面标题 -->
    <view class="page-header">
      <view class="header-title">{{pageMode === 'create' ? '新建规则' : pageMode === 'view' ? '查看规则' : '编辑规则'}}</view>
      <view class="header-subtitle">{{gambleHumanName}} / {{gambleUserName || '未命名规则'}}</view>
    </view>

    <!-- 配置表单 -->
    <view class="config-form">
      <!-- 规则名称组件 -->
      <RuleName
        value="{{gambleUserName}}"
        pageMode="{{pageMode}}"
        gameType="4p-lasi"
        kpiConfig="{{kpis}}"
        showGenerateHint="{{true}}"
        bind:change="onRuleNameChange"
      />

      <!-- 配置组件区域 - 固定为4人拉丝 -->
      <view class="config-components">
        <block wx:for="{{configComponents}}" wx:key="name">
          <view class="component-wrapper">
            <!-- 4人拉丝配置组件 -->
            <view class="component-content">
              <!-- KPI配置 -->
              <LasiKPI
                wx:if="{{item.name === 'LasiKPI'}}"
                id="{{item.name}}"
                mode="{{pageMode === 'view' ? 'SysConfig' : 'UserEdit'}}"
                config="{{kpis}}"
                displayValue="{{kpiDisplayValue}}"
                bind:configChange="onConfigChange"
              />

              <!-- 奖励规则配置 -->
              <LasiRewardConfig
                wx:if="{{item.name === 'LasiRewardConfig'}}"
                id="{{item.name}}"
                mode="{{pageMode === 'view' ? 'SysConfig' : 'UserEdit'}}"
                config="{{RewardConfig}}"
                showPreCondition="{{showPreCondition}}"
                bind:configChange="onConfigChange"
              />

              <!-- 顶洞规则配置 -->
              <LasiDingDong
                wx:if="{{item.name === 'LasiDingDong'}}"
                id="{{item.name}}"
                mode="{{pageMode === 'view' ? 'SysConfig' : 'UserEdit'}}"
                drawConfig="{{drawConfig}}"
                bind:configChange="onConfigChange"
              />

              <!-- 吃肉规则配置 -->
              <LasiEatmeat
                wx:if="{{item.name === 'LasiEatmeat'}}"
                id="{{item.name}}"
                mode="{{pageMode === 'view' ? 'SysConfig' : 'UserEdit'}}"
                eatingRange="{{eatingRange}}"
                meatValueConfig="{{meatValueConfig}}"
                meatMaxValue="{{meatMaxValue}}"
                disabled="{{isEatmeatDisabled}}"
                bind:configChange="onConfigChange"
              />

              <!-- 包洞规则配置 -->
              <LasiBaoDong
                wx:if="{{item.name === 'LasiBaoDong'}}"
                id="{{item.name}}"
                mode="{{pageMode === 'view' ? 'SysConfig' : 'UserEdit'}}"
                dutyConfig="{{dutyConfig}}"
                PartnerDutyCondition="{{PartnerDutyCondition}}"
                badScoreBaseLine="{{badScoreBaseLine}}"
                badScoreMaxLost="{{badScoreMaxLost}}"
                bind:configChange="onConfigChange"
              />
            </view>
          </view>
        </block>
      </view>
      <!-- 底部操作按钮 -->
      <view class="bottom-actions">
        <!-- 删除按钮 - 仅编辑模式显示 -->
        <button
          wx:if="{{pageMode === 'edit'}}"
          class="delete-btn"
          bindtap="onDeleteRule"
          disabled="{{saving}}"
        >删除</button>

        <!-- 取消按钮 -->
        <button
          class="cancel-btn"
          bindtap="onCancel"
          disabled="{{saving}}"
        >{{pageMode === 'view' ? '返回' : '取消'}}</button>

        <!-- 保存按钮 - 查看模式不显示 -->
        <button
          wx:if="{{pageMode !== 'view'}}"
          class="save-btn"
          bindtap="onSaveRule"
          loading="{{saving}}"
          disabled="{{saving}}"
        >{{saving ? '保存中...' : pageMode === 'create' ? '创建规则' : '保存修改'}}</button>
      </view>
    </view>
  </view>
</view>
