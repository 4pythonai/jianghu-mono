# èµŒåšç»„ä»¶è®¾è®¡æ¨¡å¼

## æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäº `E8421Meat` ç»„ä»¶çš„å®ç°æ–¹å¼ï¼Œå®šä¹‰äº†èµŒåšé…ç½®ç»„ä»¶çš„æ ‡å‡†è®¾è®¡æ¨¡å¼ã€‚è¯¥æ¨¡å¼ç¡®ä¿ç»„ä»¶åœ¨ä¸åŒä½¿ç”¨åœºæ™¯ä¸‹çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## æ ¸å¿ƒåŸåˆ™

### 1. å¤šæ¨¡å¼æ”¯æŒ
æ¯ä¸ªé…ç½®ç»„ä»¶å¿…é¡»æ”¯æŒä¸‰ç§ä½¿ç”¨æ¨¡å¼ï¼š
- **SysConfig**: ç³»ç»Ÿè§„åˆ™é…ç½®ï¼ˆæ–°å¢è§„åˆ™ï¼‰
- **UserEdit**: ç”¨æˆ·è§„åˆ™ç¼–è¾‘ï¼ˆç¼–è¾‘ç°æœ‰è§„åˆ™ï¼‰
- **UserConfig**: ç”¨æˆ·é…ç½®ï¼ˆå…¶ä»–åœºæ™¯ï¼Œä»storeè¯»å–ï¼‰

### 2. æ•°æ®æºåˆ†ç¦»
- **ç»„ä»¶å†…éƒ¨çŠ¶æ€**: ç”¨äº SysConfig å’Œ UserEdit æ¨¡å¼
- **Store æ•°æ®**: ç”¨äº UserConfig æ¨¡å¼
- **å¤–éƒ¨é…ç½®æ•°æ®**: é€šè¿‡ `initConfigData()` æ–¹æ³•æ³¨å…¥

### 3. æ˜¾ç¤ºå€¼è®¡ç®—ç­–ç•¥
æ ¹æ®æ¨¡å¼é€‰æ‹©ä¸åŒçš„æ•°æ®æºè®¡ç®—æ˜¾ç¤ºå€¼ï¼Œç¡®ä¿ç•Œé¢æ˜¾ç¤ºä¸å®é™…æ•°æ®çŠ¶æ€ä¸€è‡´ã€‚

## ç»„ä»¶ç»“æ„

### 1. Properties å®šä¹‰

```javascript
Component({
  properties: {
    // å¯é€‰ï¼šæ˜¾å¼å®šä¹‰modeå±æ€§
    mode: {
      type: String,
      value: 'UserConfig' // é»˜è®¤æ¨¡å¼
    }
  }
})
```

### 2. Data ç»“æ„

```javascript
data: {
  // ç»„ä»¶å†…éƒ¨çŠ¶æ€
  visible: false,
  displayValue: 'è¯·é…ç½®è§„åˆ™',
  isDisabled: false,

  // é…ç½®ç›¸å…³æ•°æ®
  configOption: 0,
  configValue: 1,
  selectedOption: 0,

  // é€‰æ‹©å™¨èŒƒå›´
  optionRange: [1, 2, 3, 4, 5],
  valueRange: Array.from({ length: 20 }, (_, i) => i + 1),
}
```

### 3. ç”Ÿå‘½å‘¨æœŸç®¡ç†

```javascript
lifetimes: {
  attached() {
    console.log('ğŸ¯ [ComponentName] ç»„ä»¶åŠ è½½ï¼Œæ¨¡å¼:', this.properties.mode);

    if (this.properties.mode === 'SysConfig') {
      // SysConfigæ¨¡å¼ï¼šä½¿ç”¨ç‹¬ç«‹çš„é…ç½®æ•°æ®ï¼Œä¸ä¾èµ–Store
      this.initializeWithDefaults();
    } else if (this.properties.mode === 'UserEdit') {
      // UserEditæ¨¡å¼ï¼šç­‰å¾…å¤–éƒ¨æ•°æ®åˆå§‹åŒ–ï¼Œä¸è‡ªåŠ¨ä»StoreåŠ è½½
      this.initializeWithDefaults();
    }

    // è®¡ç®—æ˜¾ç¤ºå€¼
    this.updateDisplayValue();
    // æ£€æŸ¥ç¦ç”¨çŠ¶æ€
    this.checkDisabledState();
  },

  detached() {
    // æ¸…ç†reaction
    if (this._storeReaction) {
      this._storeReaction();
    }
  }
}
```

### 4. æ ¸å¿ƒæ–¹æ³•

#### 4.1 åˆå§‹åŒ–æ–¹æ³•

```javascript
// ä½¿ç”¨é»˜è®¤å€¼åˆå§‹åŒ–
initializeWithDefaults() {
  this.setData({
    configOption: this.data.configOption || 0,
    configValue: this.data.configValue || 1,
    selectedOption: this.data.selectedOption || 0
  });
}

// ä»Storeåˆå§‹åŒ–ï¼ˆä»…ç”¨äºUserConfigæ¨¡å¼ï¼‰
initializeFromStore() {
  const store = G4PStore;
  // ä»storeè¯»å–æ•°æ®å¹¶è®¾ç½®åˆ°ç»„ä»¶çŠ¶æ€
  this.setData({
    configOption: store.configOption,
    configValue: store.configValue
  });
}
```

#### 4.2 æ˜¾ç¤ºå€¼è®¡ç®—

```javascript
updateDisplayValue() {
  if (this.properties.mode === 'SysConfig' || this.properties.mode === 'UserEdit' || this.properties.mode === undefined) {
    // ä½¿ç”¨ç»„ä»¶å†…éƒ¨çŠ¶æ€
    displayValue = this.getDisplayValueFromComponentData();
  } else {
    // ä½¿ç”¨Storeæ•°æ®
    displayValue = this.getDisplayValueFromStore();
  }

  this.setData({ displayValue });
}

// ä»ç»„ä»¶dataè·å–æ˜¾ç¤ºå€¼
getDisplayValueFromComponentData() {
  const { configOption, configValue, selectedOption } = this.data;
  let displayValue = '';

  // æ ¹æ®ç»„ä»¶çŠ¶æ€è®¡ç®—æ˜¾ç¤ºå€¼
  switch (configOption) {
    case 0:
      displayValue = `é€‰é¡¹${configValue}`;
      break;
    case 1:
      displayValue = 'é€‰é¡¹1';
      break;
    default:
      displayValue = 'è¯·é…ç½®è§„åˆ™';
  }

  // æ·»åŠ é¢å¤–ä¿¡æ¯
  if (selectedOption === 1) {
    displayValue += '/å·²é€‰æ‹©';
  }

  return displayValue;
}

// ä»storeè·å–æ˜¾ç¤ºå€¼
getDisplayValueFromStore() {
  const store = G4PStore;
  // ä½¿ç”¨å·¥å…·ç±»æ ¼å¼åŒ–æ˜¾ç¤ºå€¼
  return ruleFormatter.formatRule(store.configOption, store.configValue);
}
```

#### 4.3 æ•°æ®è½¬æ¢æ–¹æ³•

```javascript
// å°†ç»„ä»¶çŠ¶æ€è½¬æ¢ä¸ºé…ç½®æ•°æ®
convertComponentToConfig(componentState) {
  const { configOption, configValue, selectedOption } = componentState;
  
  let configData = null;
  switch (configOption) {
    case 0:
      configData = `OPTION_${configValue}`;
      break;
    case 1:
      configData = 'OPTION_1';
      break;
  }

  return {
    configData,
    maxValue: selectedOption === 0 ? 10000000 : configValue
  };
}

// å°†é…ç½®æ•°æ®è½¬æ¢ä¸ºç»„ä»¶çŠ¶æ€
convertConfigToComponent(configData) {
  const { configData: config, maxValue } = configData;
  const state = {};

  if (config?.startsWith('OPTION_')) {
    state.configOption = 0;
    const value = Number.parseInt(config.replace('OPTION_', ''));
    state.configValue = Number.isNaN(value) ? 1 : value;
  } else if (config === 'OPTION_1') {
    state.configOption = 1;
  } else {
    state.configOption = 0;
    state.configValue = 1;
  }

  state.selectedOption = maxValue === 10000000 ? 0 : 1;

  return state;
}
```

#### 4.4 å…¬å…±æ¥å£æ–¹æ³•

```javascript
// è·å–é…ç½®æ•°æ®ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
getConfigData() {
  const componentState = {
    configOption: this.data.configOption,
    configValue: this.data.configValue,
    selectedOption: this.data.selectedOption
  };

  return this.convertComponentToConfig(componentState);
}

// åˆå§‹åŒ–é…ç½®æ•°æ®ï¼ˆä¾›UserRuleEdité¡µé¢è°ƒç”¨ï¼‰
initConfigData(configData) {
  if (!configData) return;

  const componentState = this.convertConfigToComponent(configData);
  this.setData(componentState);
  this.updateDisplayValue();
}
```

### 5. äº‹ä»¶å¤„ç†æ–¹æ³•

```javascript
// é€‰é¡¹æ”¹å˜äº‹ä»¶
onOptionChange(e) {
  const index = Number.parseInt(e.currentTarget.dataset.index);
  this.setData({ configOption: index });
  this.updateDisplayValue();
}

// æ•°å€¼æ”¹å˜äº‹ä»¶
onValueChange(e) {
  const selectedIndex = e.detail.value;
  const selectedValue = this.data.valueRange[selectedIndex];
  this.setData({ configValue: selectedValue });
  this.updateDisplayValue();
}

// UIæ§åˆ¶æ–¹æ³•
onShowConfig() {
  this.setData({ visible: true });
}

onCancel() {
  this.setData({ visible: false });
}

onConfirm() {
  this.updateDisplayValue();
  this.setData({ visible: false });
  this.triggerEvent('confirm', {
    value: this.getConfigData()
  });
}

// ç©ºæ–¹æ³•ï¼Œç”¨äºé˜»æ­¢äº‹ä»¶å†’æ³¡
noop() {
  return;
}
```

## WXML æ¨¡æ¿ç»“æ„

### 1. åŸºæœ¬ç»“æ„

```xml
<!-- è§„åˆ™é…ç½®ç»„ä»¶ -->
<view class="rule-section {{isDisabled ? 'disabled' : ''}}" wx:if="{{!visible}}">
  <view class="form-label">è§„åˆ™åç§°</view>
  <view class="form-select" bindtap="onShowConfig">
    <view class="form-input-simulator">{{displayValue}}</view>
    <view class="select-arrow">
      <text class="arrow-circle">â–¼</text>
    </view>
  </view>
</view>

<!-- é…ç½®å¼¹çª— -->
<view wx:if="{{visible}}" class="modal-mask" bindtap="onCancel">
  <view class="modal-content" catchtap="noop">
    <view class="modal-title">è§„åˆ™é…ç½®</view>
    <view class="modal-list">
      <!-- é…ç½®é€‰é¡¹ -->
    </view>
    <view class="modal-actions">
      <button class="modal-btn cancel" bindtap="onCancel">å–æ¶ˆ</button>
      <button class="modal-btn confirm" bindtap="onConfirm">ç¡®å®š</button>
    </view>
  </view>
</view>
```

### 2. é…ç½®é€‰é¡¹æ¨¡æ¿

```xml
<!-- å•é€‰é€‰é¡¹ -->
<view class="modal-item" bindtap="onOptionChange" data-index="0">
  <view class="radio-outer {{configOption === 0 ? 'checked' : ''}}">
    <view class="radio-inner" wx:if="{{configOption === 0}}"></view>
  </view>
  <view class="option-content">
    <text>é€‰é¡¹</text>
    <picker
      wx:if="{{configOption === 0}}"
      class="value-picker"
      range="{{valueRange}}"
      value="{{configValue - 1}}"
      bindchange="onValueChange"
    >
      <view class="picker-value">{{configValue}}</view>
    </picker>
    <text wx:if="{{configOption !== 0}}">{{configValue}}</text>
  </view>
</view>
```

## ä½¿ç”¨åœºæ™¯

### 1. SysConfig æ¨¡å¼ï¼ˆç³»ç»Ÿè§„åˆ™é…ç½®ï¼‰

```xml
<!-- SysEdit.wxml -->
<ComponentName mode="SysConfig" />
```

- ä½¿ç”¨ç»„ä»¶å†…éƒ¨é»˜è®¤å€¼
- ç”¨æˆ·é…ç½®æ–°è§„åˆ™
- ä¿å­˜æ—¶åˆ›å»ºæ–°è§„åˆ™

### 2. UserEdit æ¨¡å¼ï¼ˆç”¨æˆ·è§„åˆ™ç¼–è¾‘ï¼‰

```xml
<!-- UserRuleEdit.wxml -->
<ComponentName mode="UserEdit" />
```

```javascript
// UserRuleEdit.js
const componentInstance = this.selectComponent('#ComponentName');
componentInstance.initConfigData(ruleData);
```

- ç­‰å¾…å¤–éƒ¨æ•°æ®åˆå§‹åŒ–
- ç”¨æˆ·ç¼–è¾‘ç°æœ‰è§„åˆ™
- ä¿å­˜æ—¶æ›´æ–°ç°æœ‰è§„åˆ™

### 3. UserConfig æ¨¡å¼ï¼ˆç”¨æˆ·é…ç½®ï¼‰

```xml
<!-- å…¶ä»–é¡µé¢ -->
<ComponentName />
```

- ä»storeè¯»å–æ•°æ®
- ç”¨äºå…¶ä»–åœºæ™¯
- è‡ªåŠ¨åŒæ­¥åˆ°store

## æœ€ä½³å®è·µ

### 1. å‘½åè§„èŒƒ
- ç»„ä»¶åï¼š`GameTypeConfigItem`ï¼ˆå¦‚ `E8421Meat`ï¼‰
- æ–¹æ³•åï¼š`onEventName`ï¼ˆå¦‚ `onOptionChange`ï¼‰
- æ•°æ®åï¼š`camelCase`ï¼ˆå¦‚ `configOption`ï¼‰

### 2. é”™è¯¯å¤„ç†
```javascript
// æ•°æ®è§£ææ—¶æ·»åŠ é”™è¯¯å¤„ç†
if (typeof configData === 'string') {
  try {
    configData = JSON.parse(configData);
  } catch (error) {
    console.error('è§£æé…ç½®æ•°æ®å¤±è´¥:', error);
    configData = {};
  }
}
```

### 3. æ—¥å¿—è®°å½•
```javascript
console.log('ğŸ¯ [ComponentName] ç»„ä»¶åŠ è½½ï¼Œæ¨¡å¼:', this.properties.mode);
console.log('ğŸ¯ [ComponentName] é…ç½®æ•°æ®å·²æ›´æ–°:', configData);
```

### 4. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ `wx:if` è€Œä¸æ˜¯ `wx:show` æ§åˆ¶å¼¹çª—æ˜¾ç¤º
- åˆç†ä½¿ç”¨ `catchtap` é˜»æ­¢äº‹ä»¶å†’æ³¡
- åŠæ—¶æ¸…ç† reaction é¿å…å†…å­˜æ³„æ¼

## é‡æ„æŒ‡å—

### 1. ç°æœ‰ç»„ä»¶æ”¹é€ æ­¥éª¤

1. **æ·»åŠ æ¨¡å¼æ”¯æŒ**
   - åœ¨ `attached()` ä¸­æ·»åŠ æ¨¡å¼åˆ¤æ–­
   - å®ç° `initializeWithDefaults()` æ–¹æ³•

2. **ä¿®æ”¹æ˜¾ç¤ºå€¼è®¡ç®—**
   - å®ç° `getDisplayValueFromComponentData()` æ–¹æ³•
   - ä¿®æ”¹ `updateDisplayValue()` é€»è¾‘

3. **æ·»åŠ æ•°æ®è½¬æ¢æ–¹æ³•**
   - å®ç° `convertComponentToConfig()` æ–¹æ³•
   - å®ç° `convertConfigToComponent()` æ–¹æ³•

4. **æ·»åŠ å…¬å…±æ¥å£**
   - å®ç° `getConfigData()` æ–¹æ³•
   - å®ç° `initConfigData()` æ–¹æ³•

### 2. æµ‹è¯•è¦ç‚¹

- ä¸‰ç§æ¨¡å¼ä¸‹çš„åˆå§‹åŒ–æ˜¯å¦æ­£ç¡®
- æ˜¾ç¤ºå€¼è®¡ç®—æ˜¯å¦å‡†ç¡®
- æ•°æ®è½¬æ¢æ˜¯å¦å®Œæ•´
- äº‹ä»¶å¤„ç†æ˜¯å¦æ­£å¸¸
- å¼¹çª—äº¤äº’æ˜¯å¦æµç•…

## æ€»ç»“

è¯¥è®¾è®¡æ¨¡å¼ç¡®ä¿äº†é…ç½®ç»„ä»¶åœ¨ä¸åŒä½¿ç”¨åœºæ™¯ä¸‹çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚é€šè¿‡æ˜ç¡®çš„æ•°æ®æºåˆ†ç¦»å’Œæ¨¡å¼åŒ–è®¾è®¡ï¼Œä½¿å¾—ç»„ä»¶æ—¢èƒ½ç‹¬ç«‹å·¥ä½œï¼Œåˆèƒ½ä¸ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†è‰¯å¥½é›†æˆã€‚

éµå¾ªæ­¤æ¨¡å¼çš„ç»„ä»¶å°†å…·æœ‰ï¼š
- **ä¸€è‡´æ€§**ï¼šæ‰€æœ‰ç»„ä»¶éµå¾ªç›¸åŒçš„è®¾è®¡æ¨¡å¼
- **å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„ä»£ç ç»“æ„å’ŒèŒè´£åˆ†ç¦»
- **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½å’Œä¿®æ”¹ç°æœ‰åŠŸèƒ½
- **å¯æµ‹è¯•æ€§**ï¼šæ˜ç¡®çš„æ–¹æ³•èŒè´£å’Œæ•°æ®ç»“æ„
